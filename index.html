<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistem Gudang Modern - Terintegrasi</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; }
        .sidebar-item:hover { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
        .active-menu { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
        .gradient-bg { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
        .card-shadow { box-shadow: 0 10px 25px rgba(0,0,0,0.1); }
        .status-pending { background: #fef3c7; color: #92400e; }
        .status-approved { background: #d1fae5; color: #065f46; }
        .status-rejected { background: #fee2e2; color: #991b1b; }
        .loading { display: none; }
        .loading.show { display: inline-block; }
        .sync-status { padding: 8px 16px; border-radius: 6px; font-size: 12px; font-weight: 500; }
        .sync-success { background: #d1fae5; color: #065f46; }
        .sync-error { background: #fee2e2; color: #991b1b; }
        .sync-loading { background: #fef3c7; color: #92400e; }
        
        /* Login Styles */
        .login-container { 
            min-height: 100vh; 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .login-box {
            background: white;
            padding: 2rem;
            border-radius: 1rem;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            width: 100%;
            max-width: 400px;
        }
        .app-container { display: none; }
        .app-container.show { display: block; }
        
        /* Sidebar Toggle Styles */
        .sidebar { 
            transition: transform 0.3s ease-in-out; 
            z-index: 40;
        }
        .sidebar-hidden { 
            transform: translateX(-100%); 
        }
        .main-content { 
            transition: margin-left 0.3s ease-in-out; 
        }
        .main-expanded { 
            margin-left: 0; 
        }
        .menu-toggle {
            font-size: 18px;
            transition: transform 0.3s ease;
        }
        .menu-toggle.rotated {
            transform: rotate(90deg);
        }
        
        /* Mobile Responsive */
        @media (max-width: 768px) {
            .sidebar {
                position: fixed;
                z-index: 50;
            }
            .main-content {
                margin-left: 0 !important;
            }
            .sidebar-overlay {
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background: rgba(0,0,0,0.5);
                z-index: 45;
                display: none;
            }
            .sidebar-overlay.show {
                display: block;
            }
        }
    </style>
</head>
<body class="bg-gray-50">
    <!-- Login Container -->
    <div id="loginContainer" class="login-container">
        <div class="login-box">
            <div class="text-center mb-8">
                <div class="w-16 h-16 bg-gradient-to-r from-blue-500 to-purple-600 rounded-full flex items-center justify-center mx-auto mb-4">
                    <span class="text-3xl">üì¶</span>
                </div>
                <h1 class="text-2xl font-bold text-gray-800">Sistem Gudang Modern</h1>
                <p class="text-gray-600 mt-2">Silakan login untuk melanjutkan</p>
            </div>
            
            <form id="loginForm" class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Username</label>
                    <input type="text" id="loginUsername" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" required>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Password</label>
                    <input type="password" id="loginPassword" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" required>
                </div>
                <button type="submit" class="w-full gradient-bg text-white p-3 rounded-lg hover:opacity-90 transition-all font-medium">
                    <span class="loading" id="loginLoading">üîÑ</span>
                    <span id="loginText">Login</span>
                </button>
            </form>
            
            <div class="mt-6 text-center">
                <p class="text-sm text-gray-600">Default: admin / admin123</p>
            </div>
        </div>
    </div>

    <!-- App Container -->
    <div id="appContainer" class="app-container">
        <!-- Sidebar Overlay for Mobile -->
        <div id="sidebarOverlay" class="sidebar-overlay" onclick="closeSidebar()"></div>

    <!-- Header -->
    <header class="gradient-bg text-white p-4 shadow-lg fixed w-full top-0 z-50">
        <div class="flex items-center justify-between">
            <div class="flex items-center space-x-4">
                <button onclick="toggleSidebar()" class="bg-white bg-opacity-20 hover:bg-opacity-30 p-2 rounded-lg transition-all">
                    <span id="menuIcon" class="menu-toggle">‚ò∞</span>
                </button>
                <div class="w-10 h-10 bg-white rounded-lg flex items-center justify-center">
                    <span class="text-2xl">üì¶</span>
                </div>
                <h1 class="text-xl md:text-2xl font-bold">Sistem Gudang Modern</h1>
                <div id="syncStatus" class="sync-status sync-loading hidden md:block">
                    <span class="loading show">üîÑ</span> Connecting to Google Sheets...
                </div>
            </div>
            <div class="flex items-center space-x-2 md:space-x-4">
                <button onclick="testConnection()" class="bg-white bg-opacity-20 hover:bg-opacity-30 px-2 md:px-3 py-2 rounded-lg transition-all text-sm">
                    üîç <span class="hidden md:inline">Test</span>
                </button>
                <button onclick="syncWithGoogleSheets()" class="bg-white bg-opacity-20 hover:bg-opacity-30 px-2 md:px-4 py-2 rounded-lg transition-all text-sm">
                    <span class="loading" id="syncLoading">üîÑ</span>
                    <span id="syncText">üìä <span class="hidden md:inline">Sync</span></span>
                </button>
                <span id="currentTime" class="text-xs md:text-sm hidden md:block"></span>
                <div class="flex items-center space-x-2">
                    <span id="currentUser" class="text-sm hidden md:block">admin</span>
                    <div class="w-8 h-8 bg-white rounded-full flex items-center justify-center cursor-pointer" onclick="showUserMenu()">
                        <span class="text-lg">üë§</span>
                    </div>
                    <button onclick="logout()" class="bg-white bg-opacity-20 hover:bg-opacity-30 px-2 py-1 rounded text-sm">
                        üö™ <span class="hidden md:inline">Logout</span>
                    </button>
                </div>
            </div>
        </div>
    </header>

    <div class="flex pt-20">
        <!-- Sidebar -->
        <aside id="sidebar" class="sidebar w-64 bg-white shadow-lg h-screen fixed left-0 top-20 overflow-y-auto">
            <nav class="p-4">
                <ul class="space-y-2">
                    <li><button onclick="showMenu('penerimaan')" class="sidebar-item w-full text-left p-3 rounded-lg transition-all duration-300 flex items-center space-x-3 active-menu">
                        <span>üì•</span><span>Penerimaan Barang</span>
                    </button></li>
                    <li><button onclick="showMenu('transfer')" class="sidebar-item w-full text-left p-3 rounded-lg transition-all duration-300 flex items-center space-x-3">
                        <span>üöö</span><span>Transfer Barang</span>
                    </button></li>
                    <li><button onclick="showMenu('outlet')" class="sidebar-item w-full text-left p-3 rounded-lg transition-all duration-300 flex items-center space-x-3">
                        <span>üè™</span><span>Outlet</span>
                    </button></li>
                    <li><button onclick="showMenu('status')" class="sidebar-item w-full text-left p-3 rounded-lg transition-all duration-300 flex items-center space-x-3">
                        <span>üìä</span><span>Status</span>
                    </button></li>
                    <li><button onclick="showMenu('database')" class="sidebar-item w-full text-left p-3 rounded-lg transition-all duration-300 flex items-center space-x-3">
                        <span>üíæ</span><span>Database</span>
                    </button></li>
                    <li><button onclick="showMenu('riwayat')" class="sidebar-item w-full text-left p-3 rounded-lg transition-all duration-300 flex items-center space-x-3">
                        <span>üìã</span><span>Riwayat</span>
                    </button></li>
                    <li><button onclick="showMenu('laporan')" class="sidebar-item w-full text-left p-3 rounded-lg transition-all duration-300 flex items-center space-x-3">
                        <span>üìÑ</span><span>Laporan</span>
                    </button></li>
                    <li><button onclick="showMenu('user')" class="sidebar-item w-full text-left p-3 rounded-lg transition-all duration-300 flex items-center space-x-3">
                        <span>üë•</span><span>User Management</span>
                    </button></li>
                    <li><button onclick="openGoogleSheets()" class="sidebar-item w-full text-left p-3 rounded-lg transition-all duration-300 flex items-center space-x-3 bg-green-100 text-green-800">
                        <span>üìä</span><span>Buka Google Sheets</span>
                    </button></li>
                </ul>
            </nav>
        </aside>

        <!-- Main Content -->
        <main id="mainContent" class="main-content flex-1 ml-64 p-6">
            <!-- Penerimaan Barang -->
            <div id="penerimaan" class="menu-content">
                <div class="bg-white rounded-xl card-shadow p-6 mb-6">
                    <h2 class="text-2xl font-bold mb-6 text-gray-800">Penerimaan Barang</h2>
                    
                    <form id="penerimaanForm" class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                        <input type="date" id="tglPenerimaan" class="p-3 border rounded-lg focus:ring-2 focus:ring-blue-500" required>
                        <input type="text" id="kodeBarangPenerimaan" placeholder="Kode Barang" class="p-3 border rounded-lg focus:ring-2 focus:ring-blue-500" required oninput="autoFillPenerimaan()">
                        <input type="text" id="namaBarangPenerimaan" placeholder="Nama Barang" class="p-3 border rounded-lg focus:ring-2 focus:ring-blue-500" required>
                        <input type="number" id="quantityPenerimaan" placeholder="Quantity" class="p-3 border rounded-lg focus:ring-2 focus:ring-blue-500" required>
                        <select id="unitPenerimaan" class="p-3 border rounded-lg focus:ring-2 focus:ring-blue-500" required>
                            <option value="">Pilih Unit</option>
                            <option value="pcs">Pcs</option>
                            <option value="kg">Kg</option>
                            <option value="liter">Liter</option>
                            <option value="box">Box</option>
                            <option value="meter">Meter</option>
                            <option value="set">Set</option>
                        </select>
                        <select id="statusPenerimaan" class="p-3 border rounded-lg focus:ring-2 focus:ring-blue-500" required>
                            <option value="">Pilih Status</option>
                            <option value="pending">Pending</option>
                            <option value="approved">Approved</option>
                            <option value="rejected">Rejected</option>
                        </select>
                        <input type="text" id="keteranganPenerimaan" placeholder="Keterangan (opsional)" class="p-3 border rounded-lg focus:ring-2 focus:ring-blue-500">
                        <button type="submit" class="md:col-span-3 gradient-bg text-white p-3 rounded-lg hover:opacity-90 transition-all">
                            <span class="loading" id="penerimaanLoading">üîÑ</span>
                            <span id="penerimaanText">Tambah Penerimaan</span>
                        </button>
                    </form>

                    <div class="overflow-x-auto">
                        <table class="w-full border-collapse">
                            <thead>
                                <tr class="bg-gray-100">
                                    <th class="border p-3 text-left">Tanggal</th>
                                    <th class="border p-3 text-left">Kode Barang</th>
                                    <th class="border p-3 text-left">Nama Barang</th>
                                    <th class="border p-3 text-left">Quantity</th>
                                    <th class="border p-3 text-left">Unit</th>
                                    <th class="border p-3 text-left">Status</th>
                                    <th class="border p-3 text-left">Keterangan</th>
                                    <th class="border p-3 text-left">Aksi</th>
                                </tr>
                            </thead>
                            <tbody id="penerimaanTable">
                                <!-- Data akan ditambahkan secara dinamis -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Transfer Barang -->
            <div id="transfer" class="menu-content hidden">
                <div class="bg-white rounded-xl card-shadow p-6 mb-6">
                    <h2 class="text-2xl font-bold mb-6 text-gray-800">Transfer Barang</h2>
                    
                    <form id="transferForm" class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                        <input type="date" id="tglTransfer" class="p-3 border rounded-lg focus:ring-2 focus:ring-blue-500" required>
                        <input type="text" id="kodeBarangTransfer" placeholder="Kode Barang" class="p-3 border rounded-lg focus:ring-2 focus:ring-blue-500" required oninput="autoFillTransfer()">
                        <input type="text" id="namaBarangTransfer" placeholder="Nama Barang" class="p-3 border rounded-lg focus:ring-2 focus:ring-blue-500" readonly>
                        <input type="number" id="quantityTransfer" placeholder="Quantity" class="p-3 border rounded-lg focus:ring-2 focus:ring-blue-500" required>
                        <select id="unitTransfer" class="p-3 border rounded-lg focus:ring-2 focus:ring-blue-500" required disabled>
                            <option value="">Pilih Unit</option>
                            <option value="pcs">Pcs</option>
                            <option value="kg">Kg</option>
                            <option value="liter">Liter</option>
                            <option value="box">Box</option>
                            <option value="meter">Meter</option>
                            <option value="set">Set</option>
                        </select>
                        <select id="outletTransfer" class="p-3 border rounded-lg focus:ring-2 focus:ring-blue-500" required>
                            <option value="">Pilih Outlet</option>
                        </select>
                        <button type="submit" class="md:col-span-3 gradient-bg text-white p-3 rounded-lg hover:opacity-90 transition-all">
                            <span class="loading" id="transferLoading">üîÑ</span>
                            <span id="transferText">Transfer Barang</span>
                        </button>
                    </form>

                    <div class="overflow-x-auto">
                        <table class="w-full border-collapse">
                            <thead>
                                <tr class="bg-gray-100">
                                    <th class="border p-3 text-left">Tanggal</th>
                                    <th class="border p-3 text-left">Kode Barang</th>
                                    <th class="border p-3 text-left">Nama Barang</th>
                                    <th class="border p-3 text-left">Quantity</th>
                                    <th class="border p-3 text-left">Unit</th>
                                    <th class="border p-3 text-left">Outlet</th>
                                    <th class="border p-3 text-left">Status</th>
                                    <th class="border p-3 text-left">Aksi</th>
                                </tr>
                            </thead>
                            <tbody id="transferTable">
                                <!-- Data akan ditambahkan secara dinamis -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Outlet -->
            <div id="outlet" class="menu-content hidden">
                <div class="bg-white rounded-xl card-shadow p-6 mb-6">
                    <h2 class="text-2xl font-bold mb-6 text-gray-800">Manajemen Outlet</h2>
                    
                    <form id="outletForm" class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                        <input type="text" id="kodeOutlet" placeholder="Kode Outlet" class="p-3 border rounded-lg focus:ring-2 focus:ring-blue-500" required>
                        <input type="text" id="namaOutlet" placeholder="Nama Outlet" class="p-3 border rounded-lg focus:ring-2 focus:ring-blue-500" required>
                        <button type="submit" class="md:col-span-2 gradient-bg text-white p-3 rounded-lg hover:opacity-90 transition-all">
                            <span class="loading" id="outletLoading">üîÑ</span>
                            <span id="outletText">Tambah Outlet</span>
                        </button>
                    </form>

                    <div class="overflow-x-auto">
                        <table class="w-full border-collapse">
                            <thead>
                                <tr class="bg-gray-100">
                                    <th class="border p-3 text-left">Kode Outlet</th>
                                    <th class="border p-3 text-left">Nama Outlet</th>
                                    <th class="border p-3 text-left">Status</th>
                                    <th class="border p-3 text-left">Aksi</th>
                                </tr>
                            </thead>
                            <tbody id="outletTable">
                                <!-- Data akan ditambahkan secara dinamis -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Status -->
            <div id="status" class="menu-content hidden">
                <div class="bg-white rounded-xl card-shadow p-6 mb-6">
                    <h2 class="text-2xl font-bold mb-6 text-gray-800">Status Barang</h2>
                    
                    <div class="overflow-x-auto">
                        <table class="w-full border-collapse">
                            <thead>
                                <tr class="bg-gray-100">
                                    <th class="border p-3 text-left">Tanggal</th>
                                    <th class="border p-3 text-left">Kode Barang</th>
                                    <th class="border p-3 text-left">Nama Barang</th>
                                    <th class="border p-3 text-left">Quantity</th>
                                    <th class="border p-3 text-left">Unit</th>
                                    <th class="border p-3 text-left">Status</th>
                                    <th class="border p-3 text-left">Keterangan</th>
                                    <th class="border p-3 text-left">Aksi</th>
                                </tr>
                            </thead>
                            <tbody id="statusTable">
                                <!-- Data akan ditampilkan secara dinamis -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Database -->
            <div id="database" class="menu-content hidden">
                <div class="bg-white rounded-xl card-shadow p-6 mb-6">
                    <h2 class="text-2xl font-bold mb-6 text-gray-800">Database Barang</h2>
                    
                    <div class="overflow-x-auto">
                        <table class="w-full border-collapse">
                            <thead>
                                <tr class="bg-gray-100">
                                    <th class="border p-3 text-left">Kode Barang</th>
                                    <th class="border p-3 text-left">Nama Barang</th>
                                    <th class="border p-3 text-left">Stock</th>
                                    <th class="border p-3 text-left">Unit</th>
                                    <th class="border p-3 text-left">Harga</th>
                                    <th class="border p-3 text-left">Update Terakhir</th>
                                    <th class="border p-3 text-left">Aksi</th>
                                </tr>
                            </thead>
                            <tbody id="databaseTable">
                                <!-- Data akan ditampilkan secara dinamis -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Riwayat -->
            <div id="riwayat" class="menu-content hidden">
                <div class="bg-white rounded-xl card-shadow p-6 mb-6">
                    <h2 class="text-2xl font-bold mb-6 text-gray-800">Riwayat Transaksi</h2>
                    
                    <div class="overflow-x-auto">
                        <table class="w-full border-collapse">
                            <thead>
                                <tr class="bg-gray-100">
                                    <th class="border p-3 text-left">Timestamp</th>
                                    <th class="border p-3 text-left">Aktivitas</th>
                                    <th class="border p-3 text-left">Kode Barang</th>
                                    <th class="border p-3 text-left">Nama Barang</th>
                                    <th class="border p-3 text-left">Detail</th>
                                    <th class="border p-3 text-left">User</th>
                                </tr>
                            </thead>
                            <tbody id="riwayatTable">
                                <!-- Data akan ditampilkan secara dinamis -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Laporan -->
            <div id="laporan" class="menu-content hidden">
                <div class="bg-white rounded-xl card-shadow p-6 mb-6">
                    <h2 class="text-2xl font-bold mb-6 text-gray-800">Laporan</h2>
                    
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
                        <button onclick="downloadPDF()" class="bg-red-500 text-white p-4 rounded-lg hover:bg-red-600 transition-all flex items-center justify-center space-x-2">
                            <span>üìÑ</span><span>Download PDF</span>
                        </button>
                        <button onclick="downloadExcel()" class="bg-green-500 text-white p-4 rounded-lg hover:bg-green-600 transition-all flex items-center justify-center space-x-2">
                            <span>üìä</span><span>Download Excel</span>
                        </button>
                        <button onclick="printReport()" class="bg-blue-500 text-white p-4 rounded-lg hover:bg-blue-600 transition-all flex items-center justify-center space-x-2">
                            <span>üñ®Ô∏è</span><span>Print</span>
                        </button>
                        <button onclick="generateGoogleSheetsReport()" class="bg-purple-500 text-white p-4 rounded-lg hover:bg-purple-600 transition-all flex items-center justify-center space-x-2">
                            <span>üìã</span><span>Laporan Sheets</span>
                        </button>
                    </div>

                    <div class="bg-gray-50 p-4 rounded-lg">
                        <h3 class="font-semibold mb-4">Ringkasan Data:</h3>
                        <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                            <div class="bg-white p-4 rounded-lg text-center">
                                <div class="text-2xl font-bold text-blue-600" id="totalPenerimaan">0</div>
                                <div class="text-sm text-gray-600">Total Penerimaan</div>
                            </div>
                            <div class="bg-white p-4 rounded-lg text-center">
                                <div class="text-2xl font-bold text-green-600" id="totalTransfer">0</div>
                                <div class="text-sm text-gray-600">Total Transfer</div>
                            </div>
                            <div class="bg-white p-4 rounded-lg text-center">
                                <div class="text-2xl font-bold text-purple-600" id="totalOutlet">0</div>
                                <div class="text-sm text-gray-600">Total Outlet</div>
                            </div>
                            <div class="bg-white p-4 rounded-lg text-center">
                                <div class="text-2xl font-bold text-orange-600" id="totalBarang">0</div>
                                <div class="text-sm text-gray-600">Total Barang</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- User Management -->
            <div id="user" class="menu-content hidden">
                <div class="bg-white rounded-xl card-shadow p-6 mb-6">
                    <h2 class="text-2xl font-bold mb-6 text-gray-800">User Management</h2>
                    
                    <form id="userForm" class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                        <input type="text" id="newUsername" placeholder="Username" class="p-3 border rounded-lg focus:ring-2 focus:ring-blue-500" required>
                        <input type="password" id="newPassword" placeholder="Password" class="p-3 border rounded-lg focus:ring-2 focus:ring-blue-500" required>
                        <select id="userRole" class="p-3 border rounded-lg focus:ring-2 focus:ring-blue-500" required>
                            <option value="">Pilih Role</option>
                            <option value="admin">Admin</option>
                            <option value="operator">Operator</option>
                            <option value="viewer">Viewer</option>
                        </select>
                        <button type="submit" class="md:col-span-3 gradient-bg text-white p-3 rounded-lg hover:opacity-90 transition-all">
                            <span class="loading" id="userLoading">üîÑ</span>
                            <span id="userText">Tambah User</span>
                        </button>
                    </form>

                    <div class="overflow-x-auto">
                        <table class="w-full border-collapse">
                            <thead>
                                <tr class="bg-gray-100">
                                    <th class="border p-3 text-left">Username</th>
                                    <th class="border p-3 text-left">Role</th>
                                    <th class="border p-3 text-left">Status</th>
                                    <th class="border p-3 text-left">Last Login</th>
                                    <th class="border p-3 text-left">Aksi</th>
                                </tr>
                            </thead>
                            <tbody id="userTable">
                                <!-- Data akan ditambahkan secara dinamis -->
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Change Password Section -->
                <div class="bg-white rounded-xl card-shadow p-6">
                    <h3 class="text-xl font-bold mb-4 text-gray-800">Ubah Password</h3>
                    
                    <form id="changePasswordForm" class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <input type="password" id="currentPassword" placeholder="Password Lama" class="p-3 border rounded-lg focus:ring-2 focus:ring-blue-500" required>
                        <input type="password" id="newPasswordChange" placeholder="Password Baru" class="p-3 border rounded-lg focus:ring-2 focus:ring-blue-500" required>
                        <input type="password" id="confirmPassword" placeholder="Konfirmasi Password" class="p-3 border rounded-lg focus:ring-2 focus:ring-blue-500" required>
                        <button type="submit" class="md:col-span-3 bg-blue-500 text-white p-3 rounded-lg hover:bg-blue-600 transition-all">
                            <span class="loading" id="passwordLoading">üîÑ</span>
                            <span id="passwordText">Ubah Password</span>
                        </button>
                    </form>
                </div>
            </div>
        </main>
    </div>
    </div> <!-- End App Container -->

    <script>
        // Konfigurasi Google Apps Script - URL BARU
        const GOOGLE_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbwKHWwyeaj8PtZI79KH9fva4P0c8HaBCaAeB_ktOgnKkHd729lQXvycxXEYMI89Zxwe/exec';
        
        // Data storage lokal
        let penerimaanData = [];
        let transferData = [];
        let outletData = [];
        let riwayatData = [];
        let databaseData = {};
        let statusData = [];
        let userData = [];
        let currentUser = null;
        let isConnected = false;
        let sidebarOpen = true;

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            initializeUsers();
            checkLogin();
            updateTime();
            setInterval(updateTime, 1000);
            
            // Set default dates
            document.getElementById('tglPenerimaan').value = new Date().toISOString().split('T')[0];
            document.getElementById('tglTransfer').value = new Date().toISOString().split('T')[0];
            
            // Check if mobile
            if (window.innerWidth <= 768) {
                closeSidebar();
            }
        });

        // Sidebar toggle functions
        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            const mainContent = document.getElementById('mainContent');
            const menuIcon = document.getElementById('menuIcon');
            const overlay = document.getElementById('sidebarOverlay');
            
            if (sidebarOpen) {
                closeSidebar();
            } else {
                openSidebar();
            }
        }

        function openSidebar() {
            const sidebar = document.getElementById('sidebar');
            const mainContent = document.getElementById('mainContent');
            const menuIcon = document.getElementById('menuIcon');
            const overlay = document.getElementById('sidebarOverlay');
            
            sidebar.classList.remove('sidebar-hidden');
            menuIcon.textContent = '‚úï';
            menuIcon.classList.add('rotated');
            sidebarOpen = true;
            
            // For mobile, show overlay
            if (window.innerWidth <= 768) {
                overlay.classList.add('show');
            } else {
                mainContent.classList.remove('main-expanded');
            }
        }

        function closeSidebar() {
            const sidebar = document.getElementById('sidebar');
            const mainContent = document.getElementById('mainContent');
            const menuIcon = document.getElementById('menuIcon');
            const overlay = document.getElementById('sidebarOverlay');
            
            sidebar.classList.add('sidebar-hidden');
            menuIcon.textContent = '‚ò∞';
            menuIcon.classList.remove('rotated');
            sidebarOpen = false;
            
            // For mobile, hide overlay
            if (window.innerWidth <= 768) {
                overlay.classList.remove('show');
            } else {
                mainContent.classList.add('main-expanded');
            }
        }

        // Handle window resize
        window.addEventListener('resize', function() {
            if (window.innerWidth <= 768) {
                // Mobile: always close sidebar and remove main content margin
                document.getElementById('mainContent').classList.add('main-expanded');
                if (sidebarOpen) {
                    document.getElementById('sidebarOverlay').classList.add('show');
                }
            } else {
                // Desktop: restore proper layout
                document.getElementById('sidebarOverlay').classList.remove('show');
                if (sidebarOpen) {
                    document.getElementById('mainContent').classList.remove('main-expanded');
                } else {
                    document.getElementById('mainContent').classList.add('main-expanded');
                }
            }
        });

        // Initialize users
        function initializeUsers() {
            const savedUsers = localStorage.getItem('gudangUsers');
            if (savedUsers) {
                userData = JSON.parse(savedUsers);
            } else {
                // Default admin user
                userData = [
                    {
                        username: 'admin',
                        password: 'admin123',
                        role: 'admin',
                        status: 'active',
                        lastLogin: null,
                        createdAt: new Date()
                    }
                ];
                saveUsers();
            }
        }

        // Save users to localStorage
        function saveUsers() {
            localStorage.setItem('gudangUsers', JSON.stringify(userData));
        }

        // Check login status
        function checkLogin() {
            const savedUser = localStorage.getItem('currentUser');
            if (savedUser) {
                currentUser = JSON.parse(savedUser);
                showApp();
            } else {
                showLogin();
            }
        }

        // Show login page
        function showLogin() {
            document.getElementById('loginContainer').style.display = 'flex';
            document.getElementById('appContainer').classList.remove('show');
        }

        // Show app
        function showApp() {
            document.getElementById('loginContainer').style.display = 'none';
            document.getElementById('appContainer').classList.add('show');
            document.getElementById('currentUser').textContent = currentUser.username;
            initializeApp();
        }

        // Login form handler
        document.getElementById('loginForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const username = document.getElementById('loginUsername').value;
            const password = document.getElementById('loginPassword').value;
            const loadingEl = document.getElementById('loginLoading');
            const textEl = document.getElementById('loginText');
            
            loadingEl.classList.add('show');
            textEl.textContent = 'Logging in...';
            
            // Simulate loading delay
            setTimeout(() => {
                const user = userData.find(u => u.username === username && u.password === password && u.status === 'active');
                
                if (user) {
                    user.lastLogin = new Date();
                    saveUsers();
                    
                    currentUser = user;
                    localStorage.setItem('currentUser', JSON.stringify(user));
                    
                    textEl.textContent = '‚úÖ Success!';
                    setTimeout(() => {
                        showApp();
                        this.reset();
                        textEl.textContent = 'Login';
                    }, 1000);
                } else {
                    textEl.textContent = '‚ùå Invalid!';
                    alert('‚ùå Username atau password salah!');
                    setTimeout(() => {
                        textEl.textContent = 'Login';
                    }, 2000);
                }
                
                loadingEl.classList.remove('show');
            }, 1000);
        });

        // Logout function
        function logout() {
            if (confirm('Yakin ingin logout?')) {
                localStorage.removeItem('currentUser');
                currentUser = null;
                showLogin();
            }
        }

        // User form handler
        document.getElementById('userForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const username = document.getElementById('newUsername').value;
            const password = document.getElementById('newPassword').value;
            const role = document.getElementById('userRole').value;
            const loadingEl = document.getElementById('userLoading');
            const textEl = document.getElementById('userText');
            
            // Check if username already exists
            if (userData.some(u => u.username === username)) {
                alert('‚ùå Username sudah ada!');
                return;
            }
            
            loadingEl.classList.add('show');
            textEl.textContent = 'Processing...';
            
            const newUser = {
                username: username,
                password: password,
                role: role,
                status: 'active',
                lastLogin: null,
                createdAt: new Date()
            };
            
            userData.push(newUser);
            saveUsers();
            updateUserTable();
            this.reset();
            
            textEl.textContent = '‚úÖ Berhasil!';
            setTimeout(() => {
                textEl.textContent = 'Tambah User';
                loadingEl.classList.remove('show');
            }, 2000);
        });

        // Change password form handler
        document.getElementById('changePasswordForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const currentPassword = document.getElementById('currentPassword').value;
            const newPassword = document.getElementById('newPasswordChange').value;
            const confirmPassword = document.getElementById('confirmPassword').value;
            const loadingEl = document.getElementById('passwordLoading');
            const textEl = document.getElementById('passwordText');
            
            if (currentUser.password !== currentPassword) {
                alert('‚ùå Password lama salah!');
                return;
            }
            
            if (newPassword !== confirmPassword) {
                alert('‚ùå Konfirmasi password tidak cocok!');
                return;
            }
            
            if (newPassword.length < 6) {
                alert('‚ùå Password minimal 6 karakter!');
                return;
            }
            
            loadingEl.classList.add('show');
            textEl.textContent = 'Processing...';
            
            // Update password
            const userIndex = userData.findIndex(u => u.username === currentUser.username);
            if (userIndex !== -1) {
                userData[userIndex].password = newPassword;
                currentUser.password = newPassword;
                saveUsers();
                localStorage.setItem('currentUser', JSON.stringify(currentUser));
            }
            
            this.reset();
            textEl.textContent = '‚úÖ Berhasil!';
            setTimeout(() => {
                textEl.textContent = 'Ubah Password';
                loadingEl.classList.remove('show');
            }, 2000);
        });

        // Update user table
        function updateUserTable() {
            const tbody = document.getElementById('userTable');
            tbody.innerHTML = userData.map((user, index) => `
                <tr class="hover:bg-gray-50">
                    <td class="border p-3">${user.username}</td>
                    <td class="border p-3">
                        <span class="px-2 py-1 rounded-full text-xs ${getRoleColor(user.role)}">
                            ${user.role.toUpperCase()}
                        </span>
                    </td>
                    <td class="border p-3">
                        <span class="px-2 py-1 rounded-full text-xs ${user.status === 'active' ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}">
                            ${user.status.toUpperCase()}
                        </span>
                    </td>
                    <td class="border p-3">${user.lastLogin ? new Date(user.lastLogin).toLocaleString('id-ID') : 'Belum pernah'}</td>
                    <td class="border p-3">
                        ${user.username !== 'admin' ? `
                            <button onclick="toggleUserStatus(${index})" class="bg-yellow-500 text-white px-3 py-1 rounded hover:bg-yellow-600 mr-2">
                                ${user.status === 'active' ? 'Nonaktifkan' : 'Aktifkan'}
                            </button>
                            <button onclick="deleteUser(${index})" class="bg-red-500 text-white px-3 py-1 rounded hover:bg-red-600">
                                Hapus
                            </button>
                        ` : '<span class="text-gray-500">Protected</span>'}
                    </td>
                </tr>
            `).join('');
        }

        // Get role color
        function getRoleColor(role) {
            switch(role) {
                case 'admin': return 'bg-red-100 text-red-800';
                case 'operator': return 'bg-blue-100 text-blue-800';
                case 'viewer': return 'bg-gray-100 text-gray-800';
                default: return 'bg-gray-100 text-gray-800';
            }
        }

        // Toggle user status
        function toggleUserStatus(index) {
            const user = userData[index];
            if (user.username === 'admin') {
                alert('‚ùå Admin user tidak dapat dinonaktifkan!');
                return;
            }
            
            user.status = user.status === 'active' ? 'inactive' : 'active';
            saveUsers();
            updateUserTable();
        }

        // Delete user
        function deleteUser(index) {
            const user = userData[index];
            if (user.username === 'admin') {
                alert('‚ùå Admin user tidak dapat dihapus!');
                return;
            }
            
            if (confirm(`Yakin ingin menghapus user ${user.username}?`)) {
                userData.splice(index, 1);
                saveUsers();
                updateUserTable();
            }
        }

        // Show user menu
        function showUserMenu() {
            alert(`üë§ User: ${currentUser.username}\nüîë Role: ${currentUser.role}\nüìÖ Last Login: ${currentUser.lastLogin ? new Date(currentUser.lastLogin).toLocaleString('id-ID') : 'First time'}`);
        }

        // Initialize app
        async function initializeApp() {
            console.log('üîÑ Initializing app...');
            console.log('üì° Google Script URL:', GOOGLE_SCRIPT_URL);
            
            try {
                await loadDataFromGoogleSheets();
                isConnected = true;
                console.log('‚úÖ App initialized successfully with Google Sheets');
            } catch (error) {
                console.error('‚ùå Failed to connect to Google Sheets:', error);
                updateSyncStatus('error', `‚ùå ${error.message} - Working offline`);
                loadSampleData();
                isConnected = false;
                
                // Tampilkan pesan error yang lebih detail
                setTimeout(() => {
                    console.log('‚ö†Ô∏è Working in offline mode with sample data');
                }, 1000);
            }
        }

        // Update sync status
        function updateSyncStatus(type, message) {
            const statusEl = document.getElementById('syncStatus');
            statusEl.className = `sync-status sync-${type} hidden md:block`;
            statusEl.innerHTML = message;
        }

        // Load data from Google Sheets
        async function loadDataFromGoogleSheets() {
            updateSyncStatus('loading', 'üîÑ Loading data...');
            
            try {
                // Test koneksi dengan timeout
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 10000); // 10 detik timeout
                
                const response = await fetch(`${GOOGLE_SCRIPT_URL}?action=getAllData&timestamp=${Date.now()}`, {
                    method: 'GET',
                    signal: controller.signal,
                    headers: {
                        'Accept': 'application/json',
                        'Content-Type': 'application/json'
                    }
                });
                
                clearTimeout(timeoutId);
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const data = await response.json();
                console.log('Response from Google Sheets:', data);
                
                if (data.success) {
                    penerimaanData = data.penerimaan || [];
                    transferData = data.transfer || [];
                    outletData = data.outlet || [];
                    riwayatData = data.riwayat || [];
                    databaseData = data.database || {};
                    statusData = data.status || [];
                    
                    updateAllTables();
                    updateOutletDropdown();
                    updateSyncStatus('success', '‚úÖ Connected to Google Sheets');
                    console.log('‚úÖ Data berhasil dimuat dari Google Sheets');
                } else {
                    throw new Error(data.error || 'Google Apps Script returned success: false');
                }
            } catch (error) {
                console.error('‚ùå Error connecting to Google Sheets:', error);
                if (error.name === 'AbortError') {
                    throw new Error('Connection timeout - Google Sheets tidak merespons');
                } else if (error.message.includes('CORS')) {
                    throw new Error('CORS error - Pastikan Google Apps Script sudah di-deploy dengan benar');
                } else {
                    throw new Error(`Connection failed: ${error.message}`);
                }
            }
        }

        // Sync with Google Sheets
        async function syncWithGoogleSheets() {
            if (!isConnected) {
                alert('‚ùå Tidak terhubung ke Google Sheets. Coba refresh halaman.');
                return;
            }
            
            const syncBtn = document.getElementById('syncText');
            const syncLoading = document.getElementById('syncLoading');
            
            syncBtn.innerHTML = 'üîÑ <span class="hidden md:inline">Syncing...</span>';
            syncLoading.classList.add('show');
            
            try {
                await loadDataFromGoogleSheets();
                syncBtn.innerHTML = '‚úÖ <span class="hidden md:inline">Synced!</span>';
                setTimeout(() => {
                    syncBtn.innerHTML = 'üìä <span class="hidden md:inline">Sync</span>';
                }, 2000);
            } catch (error) {
                syncBtn.innerHTML = '‚ùå <span class="hidden md:inline">Failed</span>';
                setTimeout(() => {
                    syncBtn.innerHTML = 'üìä <span class="hidden md:inline">Sync</span>';
                }, 2000);
            } finally {
                syncLoading.classList.remove('show');
            }
        }

        // Send data to Google Sheets
        async function sendToGoogleSheets(action, data) {
            if (!isConnected) {
                console.log('Offline mode - data saved locally');
                return { success: true };
            }
            
            try {
                const response = await fetch(GOOGLE_SCRIPT_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        action: action,
                        data: data
                    })
                });
                
                const result = await response.json();
                return result;
            } catch (error) {
                console.error('Error sending to Google Sheets:', error);
                return { success: false, error: error.message };
            }
        }

        // Load sample data (offline mode)
        function loadSampleData() {
            outletData = [
                { kode: 'OUT001', nama: 'Jakarta Pusat', status: 'Aktif' },
                { kode: 'OUT002', nama: 'Bandung', status: 'Aktif' },
                { kode: 'OUT003', nama: 'Surabaya', status: 'Aktif' }
            ];

            databaseData = {
                'BRG001': { nama: 'Laptop Dell', stock: 15, unit: 'pcs', harga: 8500000, updateTerakhir: new Date() },
                'BRG002': { nama: 'Mouse Wireless', stock: 25, unit: 'pcs', harga: 250000, updateTerakhir: new Date() },
                'BRG003': { nama: 'Keyboard Mechanical', stock: 8, unit: 'pcs', harga: 750000, updateTerakhir: new Date() }
            };

            statusData = [
                { kode: 'BRG004', nama: 'Monitor LED', status: 'pending', quantity: 5, unit: 'pcs', tanggal: new Date().toISOString().split('T')[0], keterangan: 'Menunggu approval' },
                { kode: 'BRG005', nama: 'Printer Laser', status: 'pending', quantity: 2, unit: 'pcs', tanggal: new Date().toISOString().split('T')[0], keterangan: 'Menunggu budget' }
            ];

            updateAllTables();
            updateOutletDropdown();
        }

        // Update current time
        function updateTime() {
            const now = new Date();
            document.getElementById('currentTime').textContent = now.toLocaleString('id-ID');
        }

        // Show menu
        function showMenu(menuName) {
            document.querySelectorAll('.menu-content').forEach(menu => {
                menu.classList.add('hidden');
            });
            
            document.querySelectorAll('.sidebar-item').forEach(item => {
                item.classList.remove('active-menu');
            });
            
            document.getElementById(menuName).classList.remove('hidden');
            event.target.classList.add('active-menu');
            
            // Update user table when user menu is shown
            if (menuName === 'user') {
                updateUserTable();
            }
            
            // Auto close sidebar on mobile after menu selection
            if (window.innerWidth <= 768) {
                closeSidebar();
            }
        }

        // Auto-fill functions
        function autoFillPenerimaan() {
            const kode = document.getElementById('kodeBarangPenerimaan').value;
            const namaField = document.getElementById('namaBarangPenerimaan');
            const unitField = document.getElementById('unitPenerimaan');
            
            if (databaseData[kode]) {
                namaField.value = databaseData[kode].nama;
                namaField.readOnly = true;
                unitField.value = databaseData[kode].unit;
                unitField.disabled = true;
            } else {
                namaField.value = '';
                namaField.readOnly = false;
                unitField.value = '';
                unitField.disabled = false;
            }
        }

        function autoFillTransfer() {
            const kode = document.getElementById('kodeBarangTransfer').value;
            const namaField = document.getElementById('namaBarangTransfer');
            const unitField = document.getElementById('unitTransfer');
            
            if (databaseData[kode]) {
                namaField.value = databaseData[kode].nama;
                unitField.value = databaseData[kode].unit;
                unitField.disabled = false;
                
                // Show stock info
                const stockInfo = `Stock tersedia: ${databaseData[kode].stock} ${databaseData[kode].unit}`;
                document.getElementById('quantityTransfer').placeholder = stockInfo;
            } else {
                namaField.value = '';
                unitField.value = '';
                unitField.disabled = true;
                document.getElementById('quantityTransfer').placeholder = 'Quantity';
                if (kode) {
                    alert('Kode barang tidak ditemukan di database!');
                }
            }
        }

        // Form handlers
        document.getElementById('penerimaanForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const loadingEl = document.getElementById('penerimaanLoading');
            const textEl = document.getElementById('penerimaanText');
            
            loadingEl.classList.add('show');
            textEl.textContent = 'Processing...';
            
            const formData = {
                tanggal: document.getElementById('tglPenerimaan').value,
                kode: document.getElementById('kodeBarangPenerimaan').value,
                nama: document.getElementById('namaBarangPenerimaan').value,
                quantity: parseInt(document.getElementById('quantityPenerimaan').value),
                unit: document.getElementById('unitPenerimaan').value,
                status: document.getElementById('statusPenerimaan').value,
                keterangan: document.getElementById('keteranganPenerimaan').value || ''
            };
            
            try {
                // Send to Google Sheets
                const result = await sendToGoogleSheets('addPenerimaan', formData);
                
                if (result.success) {
                    penerimaanData.push(formData);
                    
                    // Process based on status
                    if (formData.status === 'approved') {
                        updateDatabaseStock(formData.kode, formData.nama, formData.quantity, formData.unit);
                        addToRiwayat(formData.tanggal, formData.kode, formData.nama, `Penerimaan diterima: ${formData.quantity} ${formData.unit}`);
                    } else {
                        statusData.push(formData);
                        addToRiwayat(formData.tanggal, formData.kode, formData.nama, `Penerimaan ${formData.status}: ${formData.quantity} ${formData.unit}`);
                    }
                    
                    updateAllTables();
                    this.reset();
                    document.getElementById('tglPenerimaan').value = new Date().toISOString().split('T')[0];
                    
                    textEl.textContent = '‚úÖ Berhasil!';
                } else {
                    throw new Error(result.error || 'Failed to save');
                }
            } catch (error) {
                console.error('Error:', error);
                textEl.textContent = '‚ùå Error!';
                alert('Error: ' + error.message);
            } finally {
                loadingEl.classList.remove('show');
                setTimeout(() => {
                    textEl.textContent = 'Tambah Penerimaan';
                }, 2000);
            }
        });

        document.getElementById('transferForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const kode = document.getElementById('kodeBarangTransfer').value;
            
            if (!databaseData[kode]) {
                alert('Barang tidak ditemukan di database! Transfer tidak dapat dilakukan.');
                return;
            }
            
            const quantity = parseInt(document.getElementById('quantityTransfer').value);
            
            if (databaseData[kode].stock < quantity) {
                alert(`Stock tidak mencukupi! Stock tersedia: ${databaseData[kode].stock}`);
                return;
            }
            
            const loadingEl = document.getElementById('transferLoading');
            const textEl = document.getElementById('transferText');
            
            loadingEl.classList.add('show');
            textEl.textContent = 'Processing...';
            
            const formData = {
                tanggal: document.getElementById('tglTransfer').value,
                kode: kode,
                nama: document.getElementById('namaBarangTransfer').value,
                quantity: quantity,
                unit: document.getElementById('unitTransfer').value,
                outlet: document.getElementById('outletTransfer').value,
                status: 'Completed'
            };
            
            try {
                const result = await sendToGoogleSheets('addTransfer', formData);
                
                if (result.success) {
                    transferData.push(formData);
                    updateDatabaseStock(formData.kode, formData.nama, -formData.quantity, formData.unit);
                    addToRiwayat(formData.tanggal, formData.kode, formData.nama, `Transfer ke ${formData.outlet}: ${formData.quantity} ${formData.unit}`);
                    updateAllTables();
                    this.reset();
                    document.getElementById('tglTransfer').value = new Date().toISOString().split('T')[0];
                    
                    textEl.textContent = '‚úÖ Berhasil!';
                } else {
                    throw new Error(result.error || 'Failed to save');
                }
            } catch (error) {
                console.error('Error:', error);
                textEl.textContent = '‚ùå Error!';
                alert('Error: ' + error.message);
            } finally {
                loadingEl.classList.remove('show');
                setTimeout(() => {
                    textEl.textContent = 'Transfer Barang';
                }, 2000);
            }
        });

        document.getElementById('outletForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const kodeOutlet = document.getElementById('kodeOutlet').value;
            const namaOutlet = document.getElementById('namaOutlet').value;
            
            // Check for duplicate kode outlet
            if (outletData.some(outlet => outlet.kode === kodeOutlet)) {
                alert('‚ùå Kode outlet sudah ada! Gunakan kode yang berbeda.');
                return;
            }
            
            const loadingEl = document.getElementById('outletLoading');
            const textEl = document.getElementById('outletText');
            
            loadingEl.classList.add('show');
            textEl.textContent = 'Processing...';
            
            const formData = {
                kode: kodeOutlet,
                nama: namaOutlet,
                status: 'Aktif'
            };
            
            try {
                const result = await sendToGoogleSheets('addOutlet', formData);
                
                if (result.success) {
                    outletData.push(formData);
                    updateOutletTable();
                    updateOutletDropdown();
                    this.reset();
                    
                    textEl.textContent = '‚úÖ Berhasil!';
                } else {
                    throw new Error(result.error || 'Failed to save');
                }
            } catch (error) {
                console.error('Error:', error);
                textEl.textContent = '‚ùå Error!';
                alert('Error: ' + error.message);
            } finally {
                loadingEl.classList.remove('show');
                setTimeout(() => {
                    textEl.textContent = 'Tambah Outlet';
                }, 2000);
            }
        });

        // Update functions
        function updateDatabaseStock(kode, nama, quantity, unit) {
            if (!databaseData[kode]) {
                databaseData[kode] = { nama: nama, stock: 0, unit: unit, harga: 0, updateTerakhir: new Date() };
            }
            databaseData[kode].stock += quantity;
            databaseData[kode].updateTerakhir = new Date();
        }

        function addToRiwayat(tanggal, kode, nama, keterangan) {
            riwayatData.push({ 
                timestamp: new Date(), 
                aktivitas: 'System Update',
                kode, 
                nama, 
                detail: keterangan,
                user: 'System'
            });
        }

        function updateAllTables() {
            updatePenerimaanTable();
            updateTransferTable();
            updateOutletTable();
            updateStatusTable();
            updateDatabaseTable();
            updateRiwayatTable();
            updateSummary();
        }

        function updatePenerimaanTable() {
            const tbody = document.getElementById('penerimaanTable');
            tbody.innerHTML = penerimaanData.map((item, index) => `
                <tr class="hover:bg-gray-50">
                    <td class="border p-3">${item.tanggal}</td>
                    <td class="border p-3">${item.kode}</td>
                    <td class="border p-3">${item.nama}</td>
                    <td class="border p-3">${item.quantity}</td>
                    <td class="border p-3">${item.unit}</td>
                    <td class="border p-3">
                        <span class="px-2 py-1 rounded-full text-xs status-${item.status}">
                            ${item.status.toUpperCase()}
                        </span>
                    </td>
                    <td class="border p-3">${item.keterangan || '-'}</td>
                    <td class="border p-3">
                        <button onclick="deletePenerimaan(${index})" class="bg-red-500 text-white px-3 py-1 rounded hover:bg-red-600">
                            Hapus
                        </button>
                    </td>
                </tr>
            `).join('');
        }

        function updateTransferTable() {
            const tbody = document.getElementById('transferTable');
            tbody.innerHTML = transferData.map((item, index) => `
                <tr class="hover:bg-gray-50">
                    <td class="border p-3">${item.tanggal}</td>
                    <td class="border p-3">${item.kode}</td>
                    <td class="border p-3">${item.nama}</td>
                    <td class="border p-3">${item.quantity}</td>
                    <td class="border p-3">${item.unit}</td>
                    <td class="border p-3">${item.outlet}</td>
                    <td class="border p-3">
                        <span class="px-2 py-1 rounded-full text-xs bg-green-100 text-green-800">
                            ${item.status || 'Completed'}
                        </span>
                    </td>
                    <td class="border p-3">
                        <button onclick="deleteTransfer(${index})" class="bg-red-500 text-white px-3 py-1 rounded hover:bg-red-600">
                            Hapus
                        </button>
                    </td>
                </tr>
            `).join('');
        }

        function updateOutletTable() {
            const tbody = document.getElementById('outletTable');
            tbody.innerHTML = outletData.map((item, index) => `
                <tr class="hover:bg-gray-50">
                    <td class="border p-3">${item.kode}</td>
                    <td class="border p-3">${item.nama}</td>
                    <td class="border p-3">
                        <span class="px-2 py-1 rounded-full text-xs bg-green-100 text-green-800">
                            ${item.status || 'Aktif'}
                        </span>
                    </td>
                    <td class="border p-3">
                        <button onclick="deleteOutlet(${index})" class="bg-red-500 text-white px-3 py-1 rounded hover:bg-red-600">
                            Hapus
                        </button>
                    </td>
                </tr>
            `).join('');
        }

        function updateStatusTable() {
            const tbody = document.getElementById('statusTable');
            tbody.innerHTML = statusData.map((item, index) => `
                <tr class="hover:bg-gray-50">
                    <td class="border p-3">${item.tanggal}</td>
                    <td class="border p-3">${item.kode}</td>
                    <td class="border p-3">${item.nama}</td>
                    <td class="border p-3">${item.quantity}</td>
                    <td class="border p-3">${item.unit}</td>
                    <td class="border p-3">
                        <span class="px-2 py-1 rounded-full text-xs status-${item.status}">
                            ${item.status.toUpperCase()}
                        </span>
                    </td>
                    <td class="border p-3">${item.keterangan || '-'}</td>
                    <td class="border p-3">
                        <button onclick="approveStatus(${index})" class="bg-green-500 text-white px-3 py-1 rounded hover:bg-green-600 mr-2">
                            Terima
                        </button>
                        <button onclick="rejectStatus(${index})" class="bg-red-500 text-white px-3 py-1 rounded hover:bg-red-600">
                            Tolak
                        </button>
                    </td>
                </tr>
            `).join('');
        }

        function updateDatabaseTable() {
            const tbody = document.getElementById('databaseTable');
            tbody.innerHTML = Object.entries(databaseData).map(([kode, data]) => `
                <tr class="hover:bg-gray-50">
                    <td class="border p-3">${kode}</td>
                    <td class="border p-3">${data.nama}</td>
                    <td class="border p-3">${data.stock}</td>
                    <td class="border p-3">${data.unit}</td>
                    <td class="border p-3">Rp ${(data.harga || 0).toLocaleString('id-ID')}</td>
                    <td class="border p-3">${new Date(data.updateTerakhir).toLocaleString('id-ID')}</td>
                    <td class="border p-3">
                        <button onclick="editDatabase('${kode}')" class="bg-blue-500 text-white px-3 py-1 rounded hover:bg-blue-600 mr-2">
                            Edit
                        </button>
                        <button onclick="deleteDatabase('${kode}')" class="bg-red-500 text-white px-3 py-1 rounded hover:bg-red-600">
                            Hapus
                        </button>
                    </td>
                </tr>
            `).join('');
        }

        function updateRiwayatTable() {
            const tbody = document.getElementById('riwayatTable');
            tbody.innerHTML = riwayatData.slice(-20).reverse().map(item => `
                <tr class="hover:bg-gray-50">
                    <td class="border p-3">${new Date(item.timestamp).toLocaleString('id-ID')}</td>
                    <td class="border p-3">${item.aktivitas}</td>
                    <td class="border p-3">${item.kode}</td>
                    <td class="border p-3">${item.nama}</td>
                    <td class="border p-3">${item.detail}</td>
                    <td class="border p-3">${item.user}</td>
                </tr>
            `).join('');
        }

        function updateOutletDropdown() {
            const select = document.getElementById('outletTransfer');
            select.innerHTML = '<option value="">Pilih Outlet</option>' + 
                outletData.map(outlet => `<option value="${outlet.nama}">${outlet.nama}</option>`).join('');
        }

        function updateSummary() {
            document.getElementById('totalPenerimaan').textContent = penerimaanData.length;
            document.getElementById('totalTransfer').textContent = transferData.length;
            document.getElementById('totalOutlet').textContent = outletData.length;
            document.getElementById('totalBarang').textContent = Object.keys(databaseData).length;
        }

        // Status functions
        async function approveStatus(index) {
            const item = statusData[index];
            
            try {
                const result = await sendToGoogleSheets('approveStatus', { index, item });
                
                if (result.success) {
                    updateDatabaseStock(item.kode, item.nama, item.quantity, item.unit);
                    addToRiwayat(item.tanggal, item.kode, item.nama, `Status diubah menjadi diterima: ${item.quantity} ${item.unit}`);
                    statusData.splice(index, 1);
                    updateAllTables();
                    alert('‚úÖ Status berhasil diapprove!');
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Error: ' + error.message);
            }
        }

        async function rejectStatus(index) {
            const item = statusData[index];
            
            try {
                const result = await sendToGoogleSheets('rejectStatus', { index, item });
                
                if (result.success) {
                    statusData[index].status = 'rejected';
                    addToRiwayat(item.tanggal, item.kode, item.nama, `Status diubah menjadi ditolak: ${item.quantity} ${item.unit}`);
                    updateAllTables();
                    alert('‚ùå Status ditolak!');
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Error: ' + error.message);
            }
        }

        // Database functions
        function editDatabase(kode) {
            const data = databaseData[kode];
            const newNama = prompt('Nama Barang:', data.nama);
            const newStock = prompt('Stock:', data.stock);
            const newHarga = prompt('Harga:', data.harga);
            
            if (newNama && newStock !== null && newHarga !== null) {
                databaseData[kode].nama = newNama;
                databaseData[kode].stock = parseInt(newStock);
                databaseData[kode].harga = parseInt(newHarga);
                databaseData[kode].updateTerakhir = new Date();
                
                addToRiwayat(new Date().toISOString().split('T')[0], kode, newNama, `Database diupdate`);
                updateAllTables();
                
                // Send to Google Sheets
                sendToGoogleSheets('updateDatabase', { kode, data: databaseData[kode] });
            }
        }

        function deleteDatabase(kode) {
            if (confirm(`Yakin ingin menghapus ${databaseData[kode].nama} dari database?`)) {
                const nama = databaseData[kode].nama;
                delete databaseData[kode];
                addToRiwayat(new Date().toISOString().split('T')[0], kode, nama, 'Barang dihapus dari database');
                updateAllTables();
                
                // Send to Google Sheets
                sendToGoogleSheets('deleteDatabase', { kode });
            }
        }

        // Delete functions
        function deletePenerimaan(index) {
            if (confirm('Yakin ingin menghapus data penerimaan ini?')) {
                penerimaanData.splice(index, 1);
                updateAllTables();
                sendToGoogleSheets('deletePenerimaan', { index });
            }
        }

        function deleteTransfer(index) {
            if (confirm('Yakin ingin menghapus data transfer ini?')) {
                transferData.splice(index, 1);
                updateAllTables();
                sendToGoogleSheets('deleteTransfer', { index });
            }
        }

        function deleteOutlet(index) {
            if (confirm('Yakin ingin menghapus outlet ini?')) {
                outletData.splice(index, 1);
                updateOutletTable();
                updateOutletDropdown();
                sendToGoogleSheets('deleteOutlet', { index });
            }
        }

        // Report functions
        function downloadPDF() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            doc.setFontSize(16);
            doc.text('Laporan Sistem Gudang Modern', 20, 20);
            doc.setFontSize(10);
            doc.text('Generated: ' + new Date().toLocaleString('id-ID'), 20, 30);
            
            let yPos = 50;
            doc.setFontSize(12);
            doc.text('Data Penerimaan:', 20, yPos);
            yPos += 10;
            
            penerimaanData.forEach(item => {
                if (yPos > 270) {
                    doc.addPage();
                    yPos = 20;
                }
                doc.setFontSize(8);
                doc.text(`${item.tanggal} - ${item.kode} - ${item.nama} - ${item.quantity} ${item.unit} - ${item.status}`, 20, yPos);
                yPos += 6;
            });
            
            doc.save('laporan-gudang-' + new Date().toISOString().split('T')[0] + '.pdf');
        }

        function downloadExcel() {
            const wb = XLSX.utils.book_new();
            
            // Penerimaan sheet
            const penerimaanWS = XLSX.utils.json_to_sheet(penerimaanData);
            XLSX.utils.book_append_sheet(wb, penerimaanWS, 'Penerimaan');
            
            // Transfer sheet
            const transferWS = XLSX.utils.json_to_sheet(transferData);
            XLSX.utils.book_append_sheet(wb, transferWS, 'Transfer');
            
            // Database sheet
            const databaseArray = Object.entries(databaseData).map(([kode, data]) => ({
                kode: kode,
                nama: data.nama,
                stock: data.stock,
                unit: data.unit,
                harga: data.harga,
                updateTerakhir: data.updateTerakhir
            }));
            const databaseWS = XLSX.utils.json_to_sheet(databaseArray);
            XLSX.utils.book_append_sheet(wb, databaseWS, 'Database');
            
            // Outlet sheet
            const outletWS = XLSX.utils.json_to_sheet(outletData);
            XLSX.utils.book_append_sheet(wb, outletWS, 'Outlet');
            
            XLSX.writeFile(wb, 'laporan-gudang-' + new Date().toISOString().split('T')[0] + '.xlsx');
        }

        function printReport() {
            const printWindow = window.open('', '_blank');
            printWindow.document.write(`
                <html>
                <head>
                    <title>Laporan Sistem Gudang</title>
                    <style>
                        body { font-family: Arial, sans-serif; margin: 20px; }
                        table { width: 100%; border-collapse: collapse; margin: 20px 0; }
                        th, td { border: 1px solid #ddd; padding: 8px; text-align: left; font-size: 12px; }
                        th { background-color: #f2f2f2; }
                        h1, h2 { color: #333; }
                        .summary { background: #f9f9f9; padding: 15px; margin: 10px 0; }
                    </style>
                </head>
                <body>
                    <h1>üìä Laporan Sistem Gudang Modern</h1>
                    <p><strong>Tanggal:</strong> ${new Date().toLocaleDateString('id-ID')}</p>
                    <p><strong>Waktu:</strong> ${new Date().toLocaleTimeString('id-ID')}</p>
                    
                    <div class="summary">
                        <h3>üìà Ringkasan</h3>
                        <p>Total Penerimaan: ${penerimaanData.length}</p>
                        <p>Total Transfer: ${transferData.length}</p>
                        <p>Total Outlet: ${outletData.length}</p>
                        <p>Total Barang: ${Object.keys(databaseData).length}</p>
                    </div>
                    
                    <h2>üì• Data Penerimaan</h2>
                    <table>
                        <tr><th>Tanggal</th><th>Kode</th><th>Nama</th><th>Qty</th><th>Unit</th><th>Status</th><th>Keterangan</th></tr>
                        ${penerimaanData.map(item => `
                            <tr><td>${item.tanggal}</td><td>${item.kode}</td><td>${item.nama}</td><td>${item.quantity}</td><td>${item.unit}</td><td>${item.status}</td><td>${item.keterangan || '-'}</td></tr>
                        `).join('')}
                    </table>
                    
                    <h2>üöö Data Transfer</h2>
                    <table>
                        <tr><th>Tanggal</th><th>Kode</th><th>Nama</th><th>Qty</th><th>Unit</th><th>Outlet</th><th>Status</th></tr>
                        ${transferData.map(item => `
                            <tr><td>${item.tanggal}</td><td>${item.kode}</td><td>${item.nama}</td><td>${item.quantity}</td><td>${item.unit}</td><td>${item.outlet}</td><td>${item.status || 'Completed'}</td></tr>
                        `).join('')}
                    </table>
                    
                    <h2>üíæ Database Barang</h2>
                    <table>
                        <tr><th>Kode</th><th>Nama</th><th>Stock</th><th>Unit</th><th>Harga</th></tr>
                        ${Object.entries(databaseData).map(([kode, data]) => `
                            <tr><td>${kode}</td><td>${data.nama}</td><td>${data.stock}</td><td>${data.unit}</td><td>Rp ${(data.harga || 0).toLocaleString('id-ID')}</td></tr>
                        `).join('')}
                    </table>
                </body>
                </html>
            `);
            printWindow.document.close();
            printWindow.print();
        }

        async function generateGoogleSheetsReport() {
            if (!isConnected) {
                alert('‚ùå Tidak terhubung ke Google Sheets');
                return;
            }
            
            try {
                const result = await sendToGoogleSheets('generateReport', {});
                if (result.success) {
                    alert('‚úÖ Laporan berhasil dibuat di Google Sheets!');
                } else {
                    alert('‚ùå Gagal membuat laporan: ' + result.error);
                }
            } catch (error) {
                alert('‚ùå Error: ' + error.message);
            }
        }

        // Auto refresh data every 30 seconds if connected
        setInterval(async () => {
            if (isConnected && currentUser) {
                try {
                    await loadDataFromGoogleSheets();
                    console.log('üîÑ Auto-refresh completed');
                } catch (error) {
                    console.log('‚ö†Ô∏è Auto-refresh failed:', error.message);
                }
            }
        }, 30000);

        // Test connection to Google Sheets
        async function testConnection() {
            console.log('üîç Testing connection to Google Sheets...');
            updateSyncStatus('loading', 'üîç Testing connection...');
            
            try {
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 5000);
                
                const response = await fetch(`${GOOGLE_SCRIPT_URL}?action=test&timestamp=${Date.now()}`, {
                    method: 'GET',
                    signal: controller.signal
                });
                
                clearTimeout(timeoutId);
                
                console.log('üì° Response status:', response.status);
                console.log('üì° Response headers:', [...response.headers.entries()]);
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const text = await response.text();
                console.log('üì° Raw response:', text);
                
                let data;
                try {
                    data = JSON.parse(text);
                } catch (e) {
                    throw new Error(`Invalid JSON response: ${text.substring(0, 100)}...`);
                }
                
                console.log('üì° Parsed response:', data);
                
                if (data.success) {
                    updateSyncStatus('success', '‚úÖ Connection successful - Auto-sync enabled');
                    isConnected = true;
                    alert('‚úÖ Koneksi berhasil!\n\nüìä Google Apps Script merespons dengan baik\nüîÑ Auto-sync setiap 30 detik diaktifkan\nüìù Data akan otomatis sinkron dengan spreadsheet');
                } else {
                    throw new Error(data.error || 'Test failed');
                }
                
            } catch (error) {
                console.error('‚ùå Connection test failed:', error);
                let errorMsg = error.message;
                
                if (error.name === 'AbortError') {
                    errorMsg = 'Timeout - Google Apps Script tidak merespons dalam 5 detik';
                } else if (error.message.includes('Failed to fetch')) {
                    errorMsg = 'Network error - Periksa koneksi internet atau URL deployment';
                } else if (error.message.includes('CORS')) {
                    errorMsg = 'CORS error - Google Apps Script belum di-deploy dengan benar';
                }
                
                updateSyncStatus('error', `‚ùå ${errorMsg}`);
                isConnected = false;
                
                alert(`‚ùå Test koneksi gagal!\n\nError: ${errorMsg}\n\nSolusi:\n1. Pastikan Google Apps Script sudah di-deploy\n2. Set permissions ke "Anyone"\n3. Periksa URL deployment\n4. Coba refresh halaman\n\nüí° Sistem akan bekerja offline dengan data lokal`);
            }
        }

        // Open Google Sheets
        function openGoogleSheets() {
            // Extract spreadsheet ID from Google Apps Script URL if possible
            // Or use a default message
            alert('üìä Google Sheets akan terbuka otomatis setelah data pertama disimpan.\n\nAtau buka Google Drive dan cari file "Sistem Gudang Data"');
        }
    </script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'97c8fa4931b48de9',t:'MTc1NzQ0NDk0Mi4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
