<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistem Manajemen Gudang - Google Sheets Integration</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .sidebar-transition { transition: all 0.3s ease-in-out; }
        .content-transition { transition: margin-left 0.3s ease-in-out; }
        .card-hover { transition: all 0.2s ease-in-out; }
        .card-hover:hover { transform: translateY(-2px); box-shadow: 0 8px 25px rgba(0,0,0,0.15); }
        .modal-backdrop { backdrop-filter: blur(4px); }
        .sync-indicator { 
            position: fixed; 
            top: 20px; 
            right: 20px; 
            z-index: 1000;
            transition: all 0.3s ease;
        }
        .sync-success { background-color: #10b981; }
        .sync-error { background-color: #ef4444; }
        .sync-loading { background-color: #f59e0b; }
        @media (max-width: 768px) {
            .sidebar-mobile { transform: translateX(-100%); }
            .sidebar-mobile.open { transform: translateX(0); }
        }
    </style>
</head>
<body class="bg-gray-50 font-sans">
    <!-- Sync Status Indicator -->
    <div id="syncIndicator" class="sync-indicator hidden px-4 py-2 rounded-lg text-white text-sm font-medium shadow-lg">
        <i class="fas fa-sync-alt mr-2"></i>
        <span id="syncText">Syncing...</span>
    </div>

    <!-- Google Sheets Configuration Modal -->
    <div id="configModal" class="fixed inset-0 bg-black bg-opacity-50 modal-backdrop z-50">
        <div class="flex items-center justify-center min-h-screen p-4">
            <div class="bg-white rounded-lg shadow-xl max-w-md w-full">
                <div class="p-6">
                    <div class="flex items-center mb-4">
                        <i class="fas fa-cog text-blue-600 text-xl mr-3"></i>
                        <h3 class="text-lg font-semibold">Konfigurasi Google Sheets</h3>
                    </div>
                    <div class="mb-4 p-4 bg-blue-50 rounded-lg">
                        <p class="text-sm text-blue-800 mb-2">
                            <strong>Langkah Setup:</strong>
                        </p>
                        <ol class="text-xs text-blue-700 space-y-1">
                            <li>1. Buka Google Sheets dan buat spreadsheet baru</li>
                            <li>2. Buka Extensions â†’ Apps Script</li>
                            <li>3. Copy paste script yang disediakan</li>
                            <li>4. Deploy sebagai Web App</li>
                            <li>5. Copy URL dan masukkan di bawah</li>
                        </ol>
                    </div>
                    <form id="configForm">
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Google Apps Script Web App URL</label>
                                <input type="url" id="webAppUrl" class="w-full p-2 border border-gray-300 rounded-lg" 
                                       placeholder="https://script.google.com/macros/s/YOUR_SCRIPT_ID/exec" required>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Spreadsheet ID</label>
                                <input type="text" id="spreadsheetId" class="w-full p-2 border border-gray-300 rounded-lg" 
                                       placeholder="1BxiMVs0XRA5nFMdKvBdBZjgmUUqptlbs74OgvE2upms" required>
                            </div>
                        </div>
                        <div class="flex justify-end space-x-2 mt-6">
                            <button type="button" onclick="testConnection()" class="px-4 py-2 text-blue-600 border border-blue-300 rounded-lg hover:bg-blue-50">
                                Test Koneksi
                            </button>
                            <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
                                Simpan & Mulai
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Sidebar -->
    <div id="sidebar" class="fixed left-0 top-0 h-full bg-gradient-to-b from-blue-800 to-blue-900 text-white sidebar-transition z-30 w-64 md:w-64 sidebar-mobile">
        <div class="p-6 border-b border-blue-700">
            <div class="flex items-center justify-between">
                <h1 class="text-xl font-bold">Manajemen Gudang</h1>
                <button id="sidebarToggle" class="md:hidden text-white hover:bg-blue-700 p-2 rounded">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="mt-2 text-xs text-blue-200">
                <i class="fas fa-cloud mr-1"></i>
                <span id="connectionStatus">Offline</span>
            </div>
        </div>
        
        <nav class="mt-6">
            <a href="#" onclick="showSection('incoming')" class="nav-item flex items-center px-6 py-3 hover:bg-blue-700 transition-colors">
                <i class="fas fa-arrow-down mr-3"></i>
                <span>Incoming</span>
            </a>
            <a href="#" onclick="showSection('status')" class="nav-item flex items-center px-6 py-3 hover:bg-blue-700 transition-colors">
                <i class="fas fa-clock mr-3"></i>
                <span>Status</span>
            </a>
            <a href="#" onclick="showSection('outgoing')" class="nav-item flex items-center px-6 py-3 hover:bg-blue-700 transition-colors">
                <i class="fas fa-arrow-up mr-3"></i>
                <span>Outgoing</span>
            </a>
            <a href="#" onclick="showSection('history')" class="nav-item flex items-center px-6 py-3 hover:bg-blue-700 transition-colors">
                <i class="fas fa-history mr-3"></i>
                <span>Riwayat</span>
            </a>
            <a href="#" onclick="showSection('recap')" class="nav-item flex items-center px-6 py-3 hover:bg-blue-700 transition-colors">
                <i class="fas fa-chart-bar mr-3"></i>
                <span>Rekap Data</span>
            </a>
            <a href="#" onclick="showSection('stores')" class="nav-item flex items-center px-6 py-3 hover:bg-blue-700 transition-colors">
                <i class="fas fa-store mr-3"></i>
                <span>Kartu Store</span>
            </a>
            <a href="#" onclick="showSection('sync')" class="nav-item flex items-center px-6 py-3 hover:bg-blue-700 transition-colors">
                <i class="fas fa-sync-alt mr-3"></i>
                <span>Sinkronisasi</span>
            </a>
            <a href="#" onclick="showSection('export')" class="nav-item flex items-center px-6 py-3 hover:bg-blue-700 transition-colors">
                <i class="fas fa-download mr-3"></i>
                <span>Export</span>
            </a>
            <a href="#" onclick="showSection('settings')" class="nav-item flex items-center px-6 py-3 hover:bg-blue-700 transition-colors">
                <i class="fas fa-cog mr-3"></i>
                <span>Settings</span>
            </a>
        </nav>
    </div>

    <!-- Mobile Menu Button -->
    <button id="mobileMenuBtn" class="md:hidden fixed top-4 left-4 z-40 bg-blue-800 text-white p-3 rounded-lg shadow-lg">
        <i class="fas fa-bars"></i>
    </button>

    <!-- Main Content -->
    <div id="mainContent" class="content-transition ml-0 md:ml-64 min-h-screen">
        <!-- Header -->
        <header class="bg-white shadow-sm border-b p-4 md:p-6">
            <div class="flex items-center justify-between">
                <h2 id="pageTitle" class="text-2xl font-bold text-gray-800">Dashboard</h2>
                <div class="flex items-center space-x-4">
                    <button onclick="syncNow()" class="bg-green-600 hover:bg-green-700 text-white px-3 py-1 rounded text-sm">
                        <i class="fas fa-sync-alt mr-1"></i>Sync Now
                    </button>
                    <div class="text-sm text-gray-600">
                        <span id="currentDate"></span>
                    </div>
                </div>
            </div>
        </header>

        <!-- Content Sections -->
        <div class="p-4 md:p-6">
            <!-- Sync Section -->
            <div id="sync-section" class="section hidden">
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <!-- Sync Status -->
                    <div class="bg-white rounded-lg shadow-md p-6">
                        <h3 class="text-xl font-semibold text-gray-800 mb-4">Status Sinkronisasi</h3>
                        <div class="space-y-4">
                            <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
                                <span class="text-sm font-medium">Koneksi Google Sheets</span>
                                <span id="sheetsStatus" class="px-2 py-1 text-xs rounded-full bg-red-100 text-red-800">Disconnected</span>
                            </div>
                            <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
                                <span class="text-sm font-medium">Last Sync</span>
                                <span id="lastSync" class="text-sm text-gray-600">Never</span>
                            </div>
                            <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
                                <span class="text-sm font-medium">Auto Sync</span>
                                <label class="relative inline-flex items-center cursor-pointer">
                                    <input type="checkbox" id="autoSync" class="sr-only peer" onchange="toggleAutoSync()">
                                    <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-blue-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600"></div>
                                </label>
                            </div>
                        </div>
                        
                        <div class="mt-6 space-y-2">
                            <button onclick="syncToSheets()" class="w-full bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg">
                                <i class="fas fa-upload mr-2"></i>Upload ke Google Sheets
                            </button>
                            <button onclick="syncFromSheets()" class="w-full bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg">
                                <i class="fas fa-download mr-2"></i>Download dari Google Sheets
                            </button>
                            <button onclick="openConfigModal()" class="w-full bg-gray-600 hover:bg-gray-700 text-white px-4 py-2 rounded-lg">
                                <i class="fas fa-cog mr-2"></i>Konfigurasi Ulang
                            </button>
                        </div>
                    </div>

                    <!-- Sync Log -->
                    <div class="bg-white rounded-lg shadow-md p-6">
                        <h3 class="text-xl font-semibold text-gray-800 mb-4">Log Sinkronisasi</h3>
                        <div id="syncLog" class="space-y-2 max-h-96 overflow-y-auto">
                            <div class="text-sm text-gray-500 text-center py-8">
                                Belum ada aktivitas sinkronisasi
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Other sections remain the same as previous code -->
            <!-- Incoming Section -->
            <div id="incoming-section" class="section">
                <div class="bg-white rounded-lg shadow-md p-6">
                    <div class="flex justify-between items-center mb-6">
                        <h3 class="text-xl font-semibold text-gray-800">Input Barang Masuk</h3>
                        <button onclick="openAddItemModal()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg transition-colors">
                            <i class="fas fa-plus mr-2"></i>Tambah Barang
                        </button>
                    </div>
                    
                    <div class="overflow-x-auto">
                        <table class="w-full table-auto">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-4 py-3 text-left text-sm font-medium text-gray-700">Tanggal</th>
                                    <th class="px-4 py-3 text-left text-sm font-medium text-gray-700">Kode Barang</th>
                                    <th class="px-4 py-3 text-left text-sm font-medium text-gray-700">Nama Barang</th>
                                    <th class="px-4 py-3 text-left text-sm font-medium text-gray-700">Qty</th>
                                    <th class="px-4 py-3 text-left text-sm font-medium text-gray-700">Unit</th>
                                    <th class="px-4 py-3 text-left text-sm font-medium text-gray-700">Status</th>
                                    <th class="px-4 py-3 text-left text-sm font-medium text-gray-700">Aksi</th>
                                </tr>
                            </thead>
                            <tbody id="incomingTable" class="divide-y divide-gray-200">
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Add other sections here (status, outgoing, history, recap, stores, export, settings) -->
            <!-- For brevity, I'm showing just the structure. The full sections would be identical to the previous code -->
        </div>
    </div>

    <script>
        // Google Sheets Integration
        class GoogleSheetsSync {
            constructor() {
                this.webAppUrl = localStorage.getItem('webAppUrl') || '';
                this.spreadsheetId = localStorage.getItem('spreadsheetId') || '';
                this.isConnected = false;
                this.autoSyncEnabled = localStorage.getItem('autoSync') === 'true';
                this.syncInterval = null;
                this.lastSyncTime = localStorage.getItem('lastSync') || null;
            }

            async testConnection() {
                try {
                    this.showSyncIndicator('loading', 'Testing connection...');
                    
                    const response = await fetch(this.webAppUrl, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            action: 'test',
                            spreadsheetId: this.spreadsheetId
                        })
                    });

                    const result = await response.json();
                    
                    if (result.success) {
                        this.isConnected = true;
                        this.updateConnectionStatus('Connected');
                        this.showSyncIndicator('success', 'Connection successful!');
                        this.addSyncLog('success', 'Connection test successful');
                        return true;
                    } else {
                        throw new Error(result.error || 'Connection failed');
                    }
                } catch (error) {
                    this.isConnected = false;
                    this.updateConnectionStatus('Disconnected');
                    this.showSyncIndicator('error', 'Connection failed!');
                    this.addSyncLog('error', `Connection test failed: ${error.message}`);
                    return false;
                }
            }

            async syncToSheets() {
                if (!this.webAppUrl || !this.spreadsheetId) {
                    alert('Please configure Google Sheets connection first');
                    return;
                }

                try {
                    this.showSyncIndicator('loading', 'Uploading to Google Sheets...');
                    
                    const data = {
                        action: 'upload',
                        spreadsheetId: this.spreadsheetId,
                        data: {
                            incoming: incomingItems,
                            status: statusItems,
                            outgoing: outgoingItems,
                            history: historyItems,
                            recap: recapItems,
                            stores: stores,
                            storeInventory: storeInventory,
                            timestamp: new Date().toISOString()
                        }
                    };

                    const response = await fetch(this.webAppUrl, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify(data)
                    });

                    const result = await response.json();
                    
                    if (result.success) {
                        this.lastSyncTime = new Date().toLocaleString('id-ID');
                        localStorage.setItem('lastSync', this.lastSyncTime);
                        this.updateLastSync();
                        this.showSyncIndicator('success', 'Data uploaded successfully!');
                        this.addSyncLog('success', 'Data uploaded to Google Sheets');
                    } else {
                        throw new Error(result.error || 'Upload failed');
                    }
                } catch (error) {
                    this.showSyncIndicator('error', 'Upload failed!');
                    this.addSyncLog('error', `Upload failed: ${error.message}`);
                    console.error('Sync error:', error);
                }
            }

            async syncFromSheets() {
                if (!this.webAppUrl || !this.spreadsheetId) {
                    alert('Please configure Google Sheets connection first');
                    return;
                }

                try {
                    this.showSyncIndicator('loading', 'Downloading from Google Sheets...');
                    
                    const response = await fetch(this.webAppUrl, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            action: 'download',
                            spreadsheetId: this.spreadsheetId
                        })
                    });

                    const result = await response.json();
                    
                    if (result.success && result.data) {
                        // Update local data
                        if (result.data.incoming) incomingItems = result.data.incoming;
                        if (result.data.status) statusItems = result.data.status;
                        if (result.data.outgoing) outgoingItems = result.data.outgoing;
                        if (result.data.history) historyItems = result.data.history;
                        if (result.data.recap) recapItems = result.data.recap;
                        if (result.data.stores) stores = result.data.stores;
                        if (result.data.storeInventory) storeInventory = result.data.storeInventory;
                        
                        // Save and refresh
                        saveData();
                        renderAll();
                        
                        this.lastSyncTime = new Date().toLocaleString('id-ID');
                        localStorage.setItem('lastSync', this.lastSyncTime);
                        this.updateLastSync();
                        this.showSyncIndicator('success', 'Data downloaded successfully!');
                        this.addSyncLog('success', 'Data downloaded from Google Sheets');
                    } else {
                        throw new Error(result.error || 'Download failed');
                    }
                } catch (error) {
                    this.showSyncIndicator('error', 'Download failed!');
                    this.addSyncLog('error', `Download failed: ${error.message}`);
                    console.error('Sync error:', error);
                }
            }

            showSyncIndicator(type, message) {
                const indicator = document.getElementById('syncIndicator');
                const text = document.getElementById('syncText');
                
                indicator.className = `sync-indicator px-4 py-2 rounded-lg text-white text-sm font-medium shadow-lg sync-${type}`;
                text.textContent = message;
                indicator.classList.remove('hidden');
                
                if (type !== 'loading') {
                    setTimeout(() => {
                        indicator.classList.add('hidden');
                    }, 3000);
                }
            }

            updateConnectionStatus(status) {
                document.getElementById('connectionStatus').textContent = status;
                const statusElement = document.getElementById('sheetsStatus');
                if (status === 'Connected') {
                    statusElement.className = 'px-2 py-1 text-xs rounded-full bg-green-100 text-green-800';
                    statusElement.textContent = 'Connected';
                } else {
                    statusElement.className = 'px-2 py-1 text-xs rounded-full bg-red-100 text-red-800';
                    statusElement.textContent = 'Disconnected';
                }
            }

            updateLastSync() {
                document.getElementById('lastSync').textContent = this.lastSyncTime || 'Never';
            }

            addSyncLog(type, message) {
                const logContainer = document.getElementById('syncLog');
                const timestamp = new Date().toLocaleString('id-ID');
                
                const logEntry = document.createElement('div');
                logEntry.className = `flex items-center justify-between p-2 rounded text-sm ${
                    type === 'success' ? 'bg-green-50 text-green-800' : 
                    type === 'error' ? 'bg-red-50 text-red-800' : 
                    'bg-blue-50 text-blue-800'
                }`;
                
                logEntry.innerHTML = `
                    <span>${message}</span>
                    <span class="text-xs opacity-75">${timestamp}</span>
                `;
                
                // Remove placeholder if exists
                const placeholder = logContainer.querySelector('.text-center');
                if (placeholder) {
                    placeholder.remove();
                }
                
                logContainer.insertBefore(logEntry, logContainer.firstChild);
                
                // Keep only last 50 entries
                while (logContainer.children.length > 50) {
                    logContainer.removeChild(logContainer.lastChild);
                }
            }

            startAutoSync() {
                if (this.syncInterval) {
                    clearInterval(this.syncInterval);
                }
                
                this.syncInterval = setInterval(() => {
                    if (this.isConnected) {
                        this.syncToSheets();
                    }
                }, 300000); // Sync every 5 minutes
            }

            stopAutoSync() {
                if (this.syncInterval) {
                    clearInterval(this.syncInterval);
                    this.syncInterval = null;
                }
            }

            saveConfig(webAppUrl, spreadsheetId) {
                this.webAppUrl = webAppUrl;
                this.spreadsheetId = spreadsheetId;
                localStorage.setItem('webAppUrl', webAppUrl);
                localStorage.setItem('spreadsheetId', spreadsheetId);
            }
        }

        // Initialize Google Sheets sync
        const sheetsSync = new GoogleSheetsSync();

        // Data Storage (same as before)
        let stores = [
            {code: '01', name: 'GENERAL STORE (ANYER)'},
            {code: '02', name: 'General store (JKT)'},
            // ... rest of stores
        ];

        let units = ['pcs', 'kg', 'liter', 'box', 'pack', 'meter', 'roll'];
        let incomingItems = [];
        let statusItems = [];
        let outgoingItems = [];
        let historyItems = [];
        let recapItems = [];
        let storeInventory = {};
        let currentStoreCode = '';

        // Initialize app
        document.addEventListener('DOMContentLoaded', function() {
            initializeApp();
            
            // Check if configuration exists
            if (!sheetsSync.webAppUrl || !sheetsSync.spreadsheetId) {
                openConfigModal();
            } else {
                sheetsSync.testConnection();
                sheetsSync.updateLastSync();
                document.getElementById('autoSync').checked = sheetsSync.autoSyncEnabled;
                if (sheetsSync.autoSyncEnabled) {
                    sheetsSync.startAutoSync();
                }
            }
            
            showSection('incoming');
        });

        // Configuration functions
        function openConfigModal() {
            document.getElementById('webAppUrl').value = sheetsSync.webAppUrl;
            document.getElementById('spreadsheetId').value = sheetsSync.spreadsheetId;
            document.getElementById('configModal').classList.remove('hidden');
        }

        function closeConfigModal() {
            document.getElementById('configModal').classList.add('hidden');
        }

        async function testConnection() {
            const webAppUrl = document.getElementById('webAppUrl').value;
            const spreadsheetId = document.getElementById('spreadsheetId').value;
            
            if (!webAppUrl || !spreadsheetId) {
                alert('Please fill in both fields');
                return;
            }
            
            // Temporarily set values for testing
            const originalUrl = sheetsSync.webAppUrl;
            const originalId = sheetsSync.spreadsheetId;
            
            sheetsSync.webAppUrl = webAppUrl;
            sheetsSync.spreadsheetId = spreadsheetId;
            
            const success = await sheetsSync.testConnection();
            
            if (!success) {
                // Restore original values if test failed
                sheetsSync.webAppUrl = originalUrl;
                sheetsSync.spreadsheetId = originalId;
            }
        }

        document.getElementById('configForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const webAppUrl = document.getElementById('webAppUrl').value;
            const spreadsheetId = document.getElementById('spreadsheetId').value;
            
            sheetsSync.saveConfig(webAppUrl, spreadsheetId);
            
            const success = await sheetsSync.testConnection();
            if (success) {
                closeConfigModal();
                if (sheetsSync.autoSyncEnabled) {
                    sheetsSync.startAutoSync();
                }
            }
        });

        // Sync functions
        function syncNow() {
            sheetsSync.syncToSheets();
        }

        function syncToSheets() {
            sheetsSync.syncToSheets();
        }

        function syncFromSheets() {
            sheetsSync.syncFromSheets();
        }

        function toggleAutoSync() {
            const enabled = document.getElementById('autoSync').checked;
            sheetsSync.autoSyncEnabled = enabled;
            localStorage.setItem('autoSync', enabled.toString());
            
            if (enabled) {
                sheetsSync.startAutoSync();
            } else {
                sheetsSync.stopAutoSync();
            }
        }

        // Override saveData to include auto-sync
        const originalSaveData = saveData;
        function saveData() {
            originalSaveData();
            
            // Auto-sync if enabled and connected
            if (sheetsSync.autoSyncEnabled && sheetsSync.isConnected) {
                setTimeout(() => {
                    sheetsSync.syncToSheets();
                }, 1000); // Delay to avoid too frequent syncs
            }
        }

        // Rest of the functions remain the same as the previous code
        // (initializeApp, showSection, modal functions, CRUD operations, etc.)
        
        function initializeApp() {
            updateCurrentDate();
            setupEventListeners();
            loadData();
            renderAll();
        }

        function updateCurrentDate() {
            const now = new Date();
            document.getElementById('currentDate').textContent = now.toLocaleDateString('id-ID', {
                weekday: 'long',
                year: 'numeric',
                month: 'long',
                day: 'numeric'
            });
        }

        function setupEventListeners() {
            document.getElementById('mobileMenuBtn').addEventListener('click', toggleSidebar);
            document.getElementById('sidebarToggle').addEventListener('click', toggleSidebar);
        }

        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            const mainContent = document.getElementById('mainContent');
            
            if (window.innerWidth < 768) {
                sidebar.classList.toggle('open');
            } else {
                sidebar.classList.toggle('w-16');
                sidebar.classList.toggle('w-64');
                mainContent.classList.toggle('ml-16');
                mainContent.classList.toggle('ml-64');
            }
        }

        function showSection(sectionName) {
            document.querySelectorAll('.section').forEach(section => {
                section.classList.add('hidden');
            });

            document.getElementById(sectionName + '-section').classList.remove('hidden');

            const titles = {
                'incoming': 'Barang Masuk',
                'status': 'Status Pending',
                'outgoing': 'Barang Keluar',
                'history': 'Riwayat Transaksi',
                'recap': 'Rekapitulasi Data',
                'stores': 'Kartu Store',
                'sync': 'Sinkronisasi',
                'export': 'Export Data',
                'settings': 'Pengaturan'
            };
            document.getElementById('pageTitle').textContent = titles[sectionName];

            document.querySelectorAll('.nav-item').forEach(item => {
                item.classList.remove('bg-blue-700');
            });
            event.target.classList.add('bg-blue-700');

            if (window.innerWidth < 768) {
                document.getElementById('sidebar').classList.remove('open');
            }
        }

        function renderAll() {
            // Render functions would be the same as previous code
            console.log('Rendering all sections...');
        }

        function loadData() {
            const saved = localStorage.getItem('warehouseData');
            if (saved) {
                const data = JSON.parse(saved);
                stores = data.stores || stores;
                units = data.units || units;
                incomingItems = data.incomingItems || [];
                statusItems = data.statusItems || [];
                outgoingItems = data.outgoingItems || [];
                historyItems = data.historyItems || [];
                recapItems = data.recapItems || [];
                storeInventory = data.storeInventory || {};
            }
        }
    </script>

    <!-- Google Apps Script Code (Copy this to Google Apps Script) -->
    <script type="text/plain" id="gasCode">
/**
 * Google Apps Script untuk Sistem Manajemen Gudang
 * 
 * Cara Setup:
 * 1. Buka Google Apps Script (script.google.com)
 * 2. Buat project baru
 * 3. Copy paste code ini
 * 4. Deploy sebagai Web App
 * 5. Set permissions: Execute as "Me", Access "Anyone"
 * 6. Copy URL dan gunakan di aplikasi web
 */

function doPost(e) {
  try {
    const data = JSON.parse(e.postData.contents);
    const action = data.action;
    const spreadsheetId = data.spreadsheetId;
    
    switch(action) {
      case 'test':
        return testConnection(spreadsheetId);
      case 'upload':
        return uploadData(spreadsheetId, data.data);
      case 'download':
        return downloadData(spreadsheetId);
      default:
        return ContentService
          .createTextOutput(JSON.stringify({success: false, error: 'Invalid action'}))
          .setMimeType(ContentService.MimeType.JSON);
    }
  } catch (error) {
    return ContentService
      .createTextOutput(JSON.stringify({success: false, error: error.toString()}))
      .setMimeType(ContentService.MimeType.JSON);
  }
}

function testConnection(spreadsheetId) {
  try {
    const ss = SpreadsheetApp.openById(spreadsheetId);
    const sheets = ss.getSheets();
    
    return ContentService
      .createTextOutput(JSON.stringify({
        success: true, 
        message: 'Connection successful',
        sheets: sheets.length
      }))
      .setMimeType(ContentService.MimeType.JSON);
  } catch (error) {
    return ContentService
      .createTextOutput(JSON.stringify({success: false, error: error.toString()}))
      .setMimeType(ContentService.MimeType.JSON);
  }
}

function uploadData(spreadsheetId, data) {
  try {
    const ss = SpreadsheetApp.openById(spreadsheetId);
    
    // Create or get sheets
    const sheets = {
      incoming: getOrCreateSheet(ss, 'Incoming'),
      status: getOrCreateSheet(ss, 'Status'),
      outgoing: getOrCreateSheet(ss, 'Outgoing'),
      history: getOrCreateSheet(ss, 'History'),
      recap: getOrCreateSheet(ss, 'Recap'),
      stores: getOrCreateSheet(ss, 'Stores'),
      storeInventory: getOrCreateSheet(ss, 'Store_Inventory'),
      config: getOrCreateSheet(ss, 'Config')
    };
    
    // Upload incoming data
    if (data.incoming && data.incoming.length > 0) {
      const incomingSheet = sheets.incoming;
      incomingSheet.clear();
      incomingSheet.getRange(1, 1, 1, 7).setValues([
        ['ID', 'Date', 'Code', 'Name', 'Qty', 'Unit', 'Status']
      ]);
      
      const incomingData = data.incoming.map(item => [
        item.id, item.date, item.code, item.name, item.qty, item.unit, item.status
      ]);
      
      if (incomingData.length > 0) {
        incomingSheet.getRange(2, 1, incomingData.length, 7).setValues(incomingData);
      }
    }
    
    // Upload status data
    if (data.status && data.status.length > 0) {
      const statusSheet = sheets.status;
      statusSheet.clear();
      statusSheet.getRange(1, 1, 1, 8).setValues([
        ['ID', 'Date', 'Code', 'Name', 'Qty', 'Unit', 'Status', 'Notes']
      ]);
      
      const statusData = data.status.map(item => [
        item.id, item.date, item.code, item.name, item.qty, item.unit, item.status, item.notes || ''
      ]);
      
      if (statusData.length > 0) {
        statusSheet.getRange(2, 1, statusData.length, 8).setValues(statusData);
      }
    }
    
    // Upload outgoing data
    if (data.outgoing && data.outgoing.length > 0) {
      const outgoingSheet = sheets.outgoing;
      outgoingSheet.clear();
      outgoingSheet.getRange(1, 1, 1, 7).setValues([
        ['Date', 'Code', 'Name', 'Qty', 'Unit', 'From Store', 'To Store']
      ]);
      
      const outgoingData = data.outgoing.map(item => [
        item.date, item.code, item.name, item.qty, item.unit, item.fromStore, item.toStore
      ]);
      
      if (outgoingData.length > 0) {
        outgoingSheet.getRange(2, 1, outgoingData.length, 7).setValues(outgoingData);
      }
    }
    
    // Upload history data
    if (data.history && data.history.length > 0) {
      const historySheet = sheets.history;
      historySheet.clear();
      historySheet.getRange(1, 1, 1, 6).setValues([
        ['Date', 'Type', 'Code', 'Name', 'Qty', 'Store']
      ]);
      
      const historyData = data.history.map(item => [
        item.date, item.type, item.code, item.name, item.qty, item.store
      ]);
      
      if (historyData.length > 0) {
        historySheet.getRange(2, 1, historyData.length, 6).setValues(historyData);
      }
    }
    
    // Upload recap data
    if (data.recap && data.recap.length > 0) {
      const recapSheet = sheets.recap;
      recapSheet.clear();
      recapSheet.getRange(1, 1, 1, 5).setValues([
        ['Code', 'Name', 'Qty', 'Unit', 'Min Stock']
      ]);
      
      const recapData = data.recap.map(item => [
        item.code, item.name, item.qty, item.unit, item.minStock
      ]);
      
      if (recapData.length > 0) {
        recapSheet.getRange(2, 1, recapData.length, 5).setValues(recapData);
      }
    }
    
    // Upload stores data
    if (data.stores && data.stores.length > 0) {
      const storesSheet = sheets.stores;
      storesSheet.clear();
      storesSheet.getRange(1, 1, 1, 2).setValues([
        ['Code', 'Name']
      ]);
      
      const storesData = data.stores.map(store => [
        store.code, store.name
      ]);
      
      if (storesData.length > 0) {
        storesSheet.getRange(2, 1, storesData.length, 2).setValues(storesData);
      }
    }
    
    // Upload store inventory data
    if (data.storeInventory) {
      const inventorySheet = sheets.storeInventory;
      inventorySheet.clear();
      inventorySheet.getRange(1, 1, 1, 7).setValues([
        ['Store Code', 'Code', 'Name', 'Qty', 'Unit', 'Date', 'Transaction']
      ]);
      
      let inventoryData = [];
      Object.keys(data.storeInventory).forEach(storeCode => {
        data.storeInventory[storeCode].forEach(item => {
          inventoryData.push([
            storeCode, item.code, item.name, item.qty, item.unit, item.date, item.transaction
          ]);
        });
      });
      
      if (inventoryData.length > 0) {
        inventorySheet.getRange(2, 1, inventoryData.length, 7).setValues(inventoryData);
      }
    }
    
    // Save timestamp
    const configSheet = sheets.config;
    configSheet.clear();
    configSheet.getRange(1, 1, 2, 2).setValues([
      ['Key', 'Value'],
      ['Last Upload', data.timestamp]
    ]);
    
    return ContentService
      .createTextOutput(JSON.stringify({success: true, message: 'Data uploaded successfully'}))
      .setMimeType(ContentService.MimeType.JSON);
      
  } catch (error) {
    return ContentService
      .createTextOutput(JSON.stringify({success: false, error: error.toString()}))
      .setMimeType(ContentService.MimeType.JSON);
  }
}

function downloadData(spreadsheetId) {
  try {
    const ss = SpreadsheetApp.openById(spreadsheetId);
    const result = {
      incoming: [],
      status: [],
      outgoing: [],
      history: [],
      recap: [],
      stores: [],
      storeInventory: {}
    };
    
    // Download incoming data
    try {
      const incomingSheet = ss.getSheetByName('Incoming');
      if (incomingSheet) {
        const incomingData = incomingSheet.getDataRange().getValues();
        if (incomingData.length > 1) {
          result.incoming = incomingData.slice(1).map(row => ({
            id: row[0],
            date: row[1],
            code: row[2],
            name: row[3],
            qty: row[4],
            unit: row[5],
            status: row[6]
          }));
        }
      }
    } catch (e) {
      console.log('No incoming sheet found');
    }
    
    // Download status data
    try {
      const statusSheet = ss.getSheetByName('Status');
      if (statusSheet) {
        const statusData = statusSheet.getDataRange().getValues();
        if (statusData.length > 1) {
          result.status = statusData.slice(1).map(row => ({
            id: row[0],
            date: row[1],
            code: row[2],
            name: row[3],
            qty: row[4],
            unit: row[5],
            status: row[6],
            notes: row[7] || ''
          }));
        }
      }
    } catch (e) {
      console.log('No status sheet found');
    }
    
    // Download outgoing data
    try {
      const outgoingSheet = ss.getSheetByName('Outgoing');
      if (outgoingSheet) {
        const outgoingData = outgoingSheet.getDataRange().getValues();
        if (outgoingData.length > 1) {
          result.outgoing = outgoingData.slice(1).map(row => ({
            date: row[0],
            code: row[1],
            name: row[2],
            qty: row[3],
            unit: row[4],
            fromStore: row[5],
            toStore: row[6]
          }));
        }
      }
    } catch (e) {
      console.log('No outgoing sheet found');
    }
    
    // Download history data
    try {
      const historySheet = ss.getSheetByName('History');
      if (historySheet) {
        const historyData = historySheet.getDataRange().getValues();
        if (historyData.length > 1) {
          result.history = historyData.slice(1).map(row => ({
            date: row[0],
            type: row[1],
            code: row[2],
            name: row[3],
            qty: row[4],
            store: row[5]
          }));
        }
      }
    } catch (e) {
      console.log('No history sheet found');
    }
    
    // Download recap data
    try {
      const recapSheet = ss.getSheetByName('Recap');
      if (recapSheet) {
        const recapData = recapSheet.getDataRange().getValues();
        if (recapData.length > 1) {
          result.recap = recapData.slice(1).map(row => ({
            code: row[0],
            name: row[1],
            qty: row[2],
            unit: row[3],
            minStock: row[4]
          }));
        }
      }
    } catch (e) {
      console.log('No recap sheet found');
    }
    
    // Download stores data
    try {
      const storesSheet = ss.getSheetByName('Stores');
      if (storesSheet) {
        const storesData = storesSheet.getDataRange().getValues();
        if (storesData.length > 1) {
          result.stores = storesData.slice(1).map(row => ({
            code: row[0],
            name: row[1]
          }));
        }
      }
    } catch (e) {
      console.log('No stores sheet found');
    }
    
    // Download store inventory data
    try {
      const inventorySheet = ss.getSheetByName('Store_Inventory');
      if (inventorySheet) {
        const inventoryData = inventorySheet.getDataRange().getValues();
        if (inventoryData.length > 1) {
          inventoryData.slice(1).forEach(row => {
            const storeCode = row[0];
            if (!result.storeInventory[storeCode]) {
              result.storeInventory[storeCode] = [];
            }
            result.storeInventory[storeCode].push({
              code: row[1],
              name: row[2],
              qty: row[3],
              unit: row[4],
              date: row[5],
              transaction: row[6]
            });
          });
        }
      }
    } catch (e) {
      console.log('No inventory sheet found');
    }
    
    return ContentService
      .createTextOutput(JSON.stringify({success: true, data: result}))
      .setMimeType(ContentService.MimeType.JSON);
      
  } catch (error) {
    return ContentService
      .createTextOutput(JSON.stringify({success: false, error: error.toString()}))
      .setMimeType(ContentService.MimeType.JSON);
  }
}

function getOrCreateSheet(spreadsheet, sheetName) {
  let sheet = spreadsheet.getSheetByName(sheetName);
  if (!sheet) {
    sheet = spreadsheet.insertSheet(sheetName);
  }
  return sheet;
}

// Test function untuk development
function testFunction() {
  const testData = {
    action: 'test',
    spreadsheetId: 'YOUR_SPREADSHEET_ID_HERE'
  };
  
  const result = doPost({
    postData: {
      contents: JSON.stringify(testData)
    }
  });
  
  console.log(result.getContent());
}
    </script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'98126ba6c5b4ce19',t:'MTc1ODIxNTA0Ni4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
