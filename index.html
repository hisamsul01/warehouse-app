<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistem Gudang - Sync 2 Arah</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; }
        .sidebar-collapsed { width: 4rem; }
        .sidebar-expanded { width: 16rem; }
        .menu-text { opacity: 1; transition: opacity 0.3s; }
        .sidebar-collapsed .menu-text { opacity: 0; }
        .print-area { display: none; }
        @media print {
            body * { visibility: hidden; }
            .print-area, .print-area * { visibility: visible; }
            .print-area { position: absolute; left: 0; top: 0; width: 100%; }
        }
        .sync-indicator {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 500;
            cursor: pointer;
        }
        .sync-connected { background: #10b981; color: white; }
        .sync-disconnected { background: #ef4444; color: white; }
        .sync-syncing { background: #f59e0b; color: white; }
        .sync-conflict { background: #8b5cf6; color: white; }
        
        .conflict-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 2000;
        }
        
        .data-changed {
            background-color: #fef3c7 !important;
            animation: highlight 2s ease-out;
        }
        
        @keyframes highlight {
            0% { background-color: #fbbf24; }
            100% { background-color: #fef3c7; }
        }
        
        .realtime-indicator {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: #1f2937;
            color: white;
            padding: 8px 12px;
            border-radius: 20px;
            font-size: 11px;
            z-index: 1000;
        }
    </style>
</head>
<body class="bg-gray-50">
    <!-- Sync Status Indicator -->
    <div id="syncStatus" class="sync-indicator sync-disconnected" onclick="showSyncDetails()">
        ‚ö†Ô∏è Tidak Terhubung ke Google Sheets
    </div>

    <!-- Real-time Indicator -->
    <div id="realtimeIndicator" class="realtime-indicator hidden">
        üîÑ Sinkronisasi Real-time Aktif
    </div>

    <!-- Conflict Resolution Modal -->
    <div id="conflictModal" class="conflict-modal hidden">
        <div class="bg-white rounded-lg p-6 w-96 shadow-2xl">
            <h3 class="text-lg font-bold mb-4 text-red-600">‚ö†Ô∏è Konflik Data Terdeteksi</h3>
            <p class="mb-4 text-gray-700">Data di website dan Google Sheets berbeda. Pilih versi yang ingin digunakan:</p>
            
            <div class="space-y-4">
                <div class="border rounded p-3">
                    <h4 class="font-semibold text-blue-600">üì± Versi Website (Lokal)</h4>
                    <div id="localVersion" class="text-sm text-gray-600 mt-2"></div>
                    <button onclick="resolveConflict('local')" class="mt-2 bg-blue-600 text-white px-4 py-2 rounded text-sm">Gunakan Versi Ini</button>
                </div>
                
                <div class="border rounded p-3">
                    <h4 class="font-semibold text-green-600">‚òÅÔ∏è Versi Google Sheets (Cloud)</h4>
                    <div id="cloudVersion" class="text-sm text-gray-600 mt-2"></div>
                    <button onclick="resolveConflict('cloud')" class="mt-2 bg-green-600 text-white px-4 py-2 rounded text-sm">Gunakan Versi Ini</button>
                </div>
            </div>
            
            <div class="mt-4 flex gap-2">
                <button onclick="resolveConflict('merge')" class="flex-1 bg-purple-600 text-white py-2 rounded text-sm">üîÄ Gabungkan</button>
                <button onclick="closeConflictModal()" class="flex-1 bg-gray-600 text-white py-2 rounded text-sm">Batal</button>
            </div>
        </div>
    </div>

    <!-- Sync Details Modal -->
    <div id="syncDetailsModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-lg p-6 w-96 shadow-2xl max-h-96 overflow-y-auto">
            <h3 class="text-lg font-bold mb-4">üìä Status Sinkronisasi</h3>
            
            <div class="space-y-3">
                <div class="flex justify-between">
                    <span>Status Koneksi:</span>
                    <span id="connectionStatus" class="font-semibold">-</span>
                </div>
                <div class="flex justify-between">
                    <span>Terakhir Sync:</span>
                    <span id="lastSyncTime" class="font-semibold">-</span>
                </div>
                <div class="flex justify-between">
                    <span>Mode Sync:</span>
                    <span id="syncMode" class="font-semibold">2-Arah Real-time</span>
                </div>
                <div class="flex justify-between">
                    <span>Interval:</span>
                    <span id="syncInterval" class="font-semibold">5 detik</span>
                </div>
                <div class="flex justify-between">
                    <span>Konflik Terdeteksi:</span>
                    <span id="conflictCount" class="font-semibold">0</span>
                </div>
            </div>
            
            <div class="mt-4 space-y-2">
                <h4 class="font-semibold">Log Aktivitas:</h4>
                <div id="syncLog" class="bg-gray-100 p-3 rounded text-xs max-h-32 overflow-y-auto">
                    <div>Sistem dimulai...</div>
                </div>
            </div>
            
            <div class="mt-4 flex gap-2">
                <button onclick="forceBidirectionalSync()" class="flex-1 bg-blue-600 text-white py-2 rounded text-sm">üîÑ Force Sync</button>
                <button onclick="toggleRealtimeSync()" class="flex-1 bg-green-600 text-white py-2 rounded text-sm" id="toggleSyncBtn">‚è∏Ô∏è Pause</button>
                <button onclick="closeSyncDetails()" class="flex-1 bg-gray-600 text-white py-2 rounded text-sm">Tutup</button>
            </div>
        </div>
    </div>

    <!-- Google Sheets Setup Modal -->
    <div id="sheetsSetupModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-lg p-8 w-96 shadow-2xl max-h-96 overflow-y-auto">
            <h2 class="text-2xl font-bold text-center mb-6 text-gray-800">Setup Google Sheets</h2>
            
            <div class="mb-4">
                <label class="block text-gray-700 text-sm font-medium mb-2">Google Apps Script Web App URL</label>
                <input type="text" id="webAppUrl" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="https://script.google.com/macros/s/YOUR_SCRIPT_ID/exec">
                <small class="text-gray-500">URL Web App dari Google Apps Script</small>
            </div>
            
            <div class="mb-4">
                <label class="block text-gray-700 text-sm font-medium mb-2">Mode Sinkronisasi</label>
                <select id="syncModeSelect" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <option value="bidirectional">2-Arah Real-time (Recommended)</option>
                    <option value="websiteToSheets">Website ‚Üí Sheets Only</option>
                    <option value="sheetsToWebsite">Sheets ‚Üí Website Only</option>
                    <option value="manual">Manual Sync Only</option>
                </select>
            </div>
            
            <div class="flex gap-2">
                <button onclick="setupGoogleSheets()" class="flex-1 bg-blue-600 text-white py-2 rounded-lg hover:bg-blue-700 transition duration-200">Setup</button>
                <button onclick="closeSetupModal()" class="flex-1 bg-gray-600 text-white py-2 rounded-lg hover:bg-gray-700 transition duration-200">Batal</button>
            </div>
            
            <div class="mt-4 p-4 bg-blue-50 rounded-lg max-h-64 overflow-y-auto">
                <h4 class="font-semibold text-blue-800 mb-3">üîÑ Setup Google Apps Script:</h4>
                
                <div class="space-y-3 text-sm text-blue-700">
                    <div class="border-l-4 border-blue-300 pl-3">
                        <h5 class="font-semibold text-blue-800">üìù Langkah Setup</h5>
                        <ol class="mt-2 space-y-1 list-decimal list-inside text-xs">
                            <li>Buka <a href="https://script.google.com" target="_blank" class="underline">script.google.com</a></li>
                            <li>Buat project baru ‚Üí "New Project"</li>
                            <li>Hapus kode default, copy paste kode Apps Script di bawah</li>
                            <li>Save project (Ctrl+S)</li>
                            <li>Deploy ‚Üí "New deployment" ‚Üí Type: "Web app"</li>
                            <li>Execute as: "Me", Access: "Anyone"</li>
                            <li>Deploy ‚Üí Copy URL Web App</li>
                            <li>Paste URL di field di atas</li>
                        </ol>
                        
                        <div class="mt-3 p-2 bg-gray-100 rounded text-xs">
                            <strong>üìã Kode Apps Script:</strong>
                            <div class="mt-1 text-xs font-mono bg-white p-2 rounded border max-h-32 overflow-y-auto">
function doGet(e) {
  const action = e.parameter.action;
  const callback = e.parameter.callback;
  
  let result;
  switch(action) {
    case 'ping':
      result = {status: 'success', message: 'Connected'};
      break;
    case 'getAllData':
      result = getAllData();
      break;
    default:
      result = {status: 'error', message: 'Invalid action'};
  }
  
  // Support JSONP
  if (callback) {
    return ContentService.createTextOutput(callback + '(' + JSON.stringify(result) + ')')
      .setMimeType(ContentService.MimeType.JAVASCRIPT);
  }
  
  return ContentService.createTextOutput(JSON.stringify(result))
    .setMimeType(ContentService.MimeType.JSON);
}

function getAllData() {
  try {
    const ss = SpreadsheetApp.getActiveSpreadsheet();
    if (!ss) {
      return {status: 'error', message: 'No spreadsheet found'};
    }
    
    return {
      status: 'success',
      data: {
        database: getSheetData(ss, 'Database', ['kode', 'nama', 'stock', 'unit']),
        outlets: getSheetData(ss, 'Outlets', ['kode', 'nama']),
        statusItems: getSheetData(ss, 'Status', ['kode', 'nama', 'status']),
        riwayat: getSheetData(ss, 'Riwayat', ['tanggal', 'kode', 'nama', 'keterangan'])
      }
    };
  } catch(error) {
    return {status: 'error', message: error.toString()};
  }
}

function getSheetData(ss, sheetName, columns) {
  try {
    const sheet = ss.getSheetByName(sheetName);
    if (!sheet) return [];
    
    const data = sheet.getDataRange().getValues();
    if (data.length <= 1) return [];
    
    return data.slice(1).map(row => {
      const obj = {};
      columns.forEach((col, index) => {
        obj[col] = row[index] || '';
        if (col === 'stock') obj[col] = parseInt(obj[col]) || 0;
      });
      return obj;
    });
  } catch(error) {
    return [];
  }
}
                            </div>
                        </div>
                    </div>

                    <div class="border-l-4 border-green-300 pl-3">
                        <h5 class="font-semibold text-green-800">‚ú® Fitur Real-time Sync</h5>
                        <ul class="mt-2 space-y-1 list-disc list-inside">
                            <li>Sinkronisasi 2-arah otomatis</li>
                            <li>Deteksi konflik dan resolusi</li>
                            <li>Backup otomatis</li>
                            <li>Real-time monitoring</li>
                        </ul>
                    </div>

                    <div class="border-l-4 border-yellow-300 pl-3">
                        <h5 class="font-semibold text-yellow-800">‚ö†Ô∏è Catatan Penting</h5>
                        <ul class="mt-2 space-y-1 list-disc list-inside">
                            <li>Pastikan Web App di-deploy dengan akses "Anyone"</li>
                            <li>URL harus berupa Google Apps Script Web App</li>
                            <li>Kode Apps Script akan disediakan setelah setup</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Login Modal -->
    <div id="loginModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white rounded-lg p-8 w-96 shadow-2xl">
            <h2 class="text-2xl font-bold text-center mb-6 text-gray-800">Login Sistem Gudang</h2>
            <form id="loginForm">
                <div class="mb-4">
                    <label class="block text-gray-700 text-sm font-medium mb-2">Username</label>
                    <input type="text" id="loginUsername" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                </div>
                <div class="mb-6">
                    <label class="block text-gray-700 text-sm font-medium mb-2">Password</label>
                    <input type="password" id="loginPassword" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                </div>
                <button type="submit" class="w-full bg-blue-600 text-white py-2 rounded-lg hover:bg-blue-700 transition duration-200">Login</button>
            </form>
            <div id="loginError" class="mt-4 text-red-600 text-sm text-center hidden"></div>
        </div>
    </div>

    <!-- Main Container -->
    <div id="mainContainer" class="hidden">
        <!-- Sidebar -->
        <div id="sidebar" class="fixed left-0 top-0 h-full bg-white shadow-lg transition-all duration-300 sidebar-expanded z-40">
            <div class="p-4 border-b border-gray-200">
                <div class="flex items-center justify-between">
                    <h1 class="menu-text text-xl font-bold text-gray-800">Sistem Gudang</h1>
                    <button id="toggleSidebar" class="p-2 rounded-lg hover:bg-gray-100">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path>
                        </svg>
                    </button>
                </div>
            </div>
            
            <nav class="mt-4">
                <a href="#" onclick="showMenu('penerimaan')" class="flex items-center px-4 py-3 text-gray-700 hover:bg-blue-50 hover:text-blue-600 transition duration-200">
                    <svg class="w-5 h-5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                    </svg>
                    <span class="menu-text">Penerimaan Barang</span>
                </a>
                <a href="#" onclick="showMenu('transfer')" class="flex items-center px-4 py-3 text-gray-700 hover:bg-blue-50 hover:text-blue-600 transition duration-200">
                    <svg class="w-5 h-5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7h12m0 0l-4-4m4 4l-4 4m0 6H4m0 0l4 4m-4-4l4-4"></path>
                    </svg>
                    <span class="menu-text">Transfer Barang</span>
                </a>
                <a href="#" onclick="showMenu('outlet')" class="flex items-center px-4 py-3 text-gray-700 hover:bg-blue-50 hover:text-blue-600 transition duration-200">
                    <svg class="w-5 h-5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"></path>
                    </svg>
                    <span class="menu-text">Outlet</span>
                </a>
                <a href="#" onclick="showMenu('status')" class="flex items-center px-4 py-3 text-gray-700 hover:bg-blue-50 hover:text-blue-600 transition duration-200">
                    <svg class="w-5 h-5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                    </svg>
                    <span class="menu-text">Status</span>
                </a>
                <a href="#" onclick="showMenu('database')" class="flex items-center px-4 py-3 text-gray-700 hover:bg-blue-50 hover:text-blue-600 transition duration-200">
                    <svg class="w-5 h-5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 7v10c0 2.21 3.582 4 8 4s8-1.79 8-4V7M4 7c0 2.21 3.582 4 8 4s8-1.79 8-4M4 7c0-2.21 3.582-4 8-4s8 1.79 8 4"></path>
                    </svg>
                    <span class="menu-text">Database</span>
                </a>
                <a href="#" onclick="showMenu('riwayat')" class="flex items-center px-4 py-3 text-gray-700 hover:bg-blue-50 hover:text-blue-600 transition duration-200">
                    <svg class="w-5 h-5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                    </svg>
                    <span class="menu-text">Riwayat</span>
                </a>
                <a href="#" onclick="showMenu('laporan')" class="flex items-center px-4 py-3 text-gray-700 hover:bg-blue-50 hover:text-blue-600 transition duration-200">
                    <svg class="w-5 h-5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 17v-2m3 2v-4m3 4v-6m2 10H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                    </svg>
                    <span class="menu-text">Laporan</span>
                </a>
                <a href="#" onclick="showMenu('user')" class="flex items-center px-4 py-3 text-gray-700 hover:bg-blue-50 hover:text-blue-600 transition duration-200">
                    <svg class="w-5 h-5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197m13.5-9a2.25 2.25 0 11-4.5 0 2.25 2.25 0 014.5 0z"></path>
                    </svg>
                    <span class="menu-text">User Management</span>
                </a>
                <a href="#" onclick="showSheetsSetup()" class="flex items-center px-4 py-3 text-gray-700 hover:bg-green-50 hover:text-green-600 transition duration-200">
                    <svg class="w-5 h-5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                    </svg>
                    <span class="menu-text">Google Sheets</span>
                </a>
            </nav>
            
            <div class="absolute bottom-4 left-4 right-4">
                <button onclick="logout()" class="w-full flex items-center justify-center px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition duration-200">
                    <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"></path>
                    </svg>
                    <span class="menu-text">Logout</span>
                </button>
            </div>
        </div>

        <!-- Main Content -->
        <div id="mainContent" class="ml-64 transition-all duration-300">
            <!-- Header -->
            <header class="bg-white shadow-sm border-b border-gray-200 p-4">
                <div class="flex justify-between items-center">
                    <h2 id="pageTitle" class="text-2xl font-semibold text-gray-800">Dashboard</h2>
                    <div class="flex gap-2">
                        <button id="setupSheetsBtn" onclick="showSheetsSetup()" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition duration-200 flex items-center">
                            <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"></path>
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                            </svg>
                            Setup Google Sheets
                        </button>
                        <button onclick="forceBidirectionalSync()" class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 transition duration-200 flex items-center">
                            <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                            </svg>
                            Sync 2-Arah
                        </button>
                    </div>
                </div>
            </header>

            <!-- Content Area -->
            <main class="p-6">
                <!-- Penerimaan Barang -->
                <div id="penerimaanContent" class="hidden">
                    <div class="bg-white rounded-lg shadow-sm p-6">
                        <h3 class="text-lg font-semibold mb-4">Form Penerimaan Barang</h3>
                        <form id="penerimaanForm" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Tanggal</label>
                                <input type="date" id="penerimaanTanggal" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Kode Barang</label>
                                <input type="text" id="penerimaanKode" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Nama Barang</label>
                                <input type="text" id="penerimaanNama" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Quantity</label>
                                <input type="number" id="penerimaanQty" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Unit</label>
                                <input type="text" id="penerimaanUnit" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Status</label>
                                <select id="penerimaanStatus" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                                    <option value="">Pilih Status</option>
                                    <option value="Diterima">Diterima</option>
                                    <option value="Ditolak">Ditolak</option>
                                    <option value="Pending">Pending</option>
                                </select>
                            </div>
                            <div class="md:col-span-2">
                                <button type="submit" class="bg-blue-600 text-white px-6 py-2 rounded-lg hover:bg-blue-700 transition duration-200">Simpan</button>
                            </div>
                        </form>
                    </div>
                </div>

                <!-- Transfer Barang -->
                <div id="transferContent" class="hidden">
                    <div class="bg-white rounded-lg shadow-sm p-6">
                        <h3 class="text-lg font-semibold mb-4">Form Transfer Barang</h3>
                        <form id="transferForm" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Tanggal</label>
                                <input type="date" id="transferTanggal" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Kode Barang</label>
                                <input type="text" id="transferKode" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Nama Barang</label>
                                <input type="text" id="transferNama" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" readonly>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Quantity</label>
                                <input type="number" id="transferQty" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Unit</label>
                                <input type="text" id="transferUnit" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" readonly>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Outlet</label>
                                <select id="transferOutlet" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                                    <option value="">Pilih Outlet</option>
                                </select>
                            </div>
                            <div class="md:col-span-2">
                                <button type="submit" class="bg-blue-600 text-white px-6 py-2 rounded-lg hover:bg-blue-700 transition duration-200">Transfer</button>
                            </div>
                        </form>
                    </div>
                </div>

                <!-- Outlet -->
                <div id="outletContent" class="hidden">
                    <div class="bg-white rounded-lg shadow-sm p-6">
                        <h3 class="text-lg font-semibold mb-4">Data Outlet</h3>
                        <form id="outletForm" class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Kode Outlet</label>
                                <input type="text" id="outletKode" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Nama Outlet</label>
                                <input type="text" id="outletNama" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                            </div>
                            <div class="md:col-span-2">
                                <button type="submit" class="bg-blue-600 text-white px-6 py-2 rounded-lg hover:bg-blue-700 transition duration-200">Tambah Outlet</button>
                            </div>
                        </form>
                        
                        <div class="overflow-x-auto">
                            <table class="min-w-full bg-white border border-gray-200">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Kode Outlet</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Nama Outlet</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Aksi</th>
                                    </tr>
                                </thead>
                                <tbody id="outletTable" class="bg-white divide-y divide-gray-200">
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Status -->
                <div id="statusContent" class="hidden">
                    <div class="bg-white rounded-lg shadow-sm p-6">
                        <h3 class="text-lg font-semibold mb-4">Status Barang Pending/Ditolak</h3>
                        <div class="overflow-x-auto">
                            <table class="min-w-full bg-white border border-gray-200">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Kode Barang</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Nama Barang</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Aksi</th>
                                    </tr>
                                </thead>
                                <tbody id="statusTable" class="bg-white divide-y divide-gray-200">
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Database -->
                <div id="databaseContent" class="hidden">
                    <div class="bg-white rounded-lg shadow-sm p-6">
                        <h3 class="text-lg font-semibold mb-4">Database Barang</h3>
                        <div class="overflow-x-auto">
                            <table class="min-w-full bg-white border border-gray-200">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Kode Barang</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Nama Barang</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Stock</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Unit</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Aksi</th>
                                    </tr>
                                </thead>
                                <tbody id="databaseTable" class="bg-white divide-y divide-gray-200">
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Riwayat -->
                <div id="riwayatContent" class="hidden">
                    <div class="bg-white rounded-lg shadow-sm p-6">
                        <h3 class="text-lg font-semibold mb-4">Riwayat Transaksi</h3>
                        <div class="overflow-x-auto">
                            <table class="min-w-full bg-white border border-gray-200">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Tanggal</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Kode Barang</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Nama Barang</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Keterangan</th>
                                    </tr>
                                </thead>
                                <tbody id="riwayatTable" class="bg-white divide-y divide-gray-200">
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Laporan -->
                <div id="laporanContent" class="hidden">
                    <div class="bg-white rounded-lg shadow-sm p-6">
                        <h3 class="text-lg font-semibold mb-4">Download Laporan</h3>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <button onclick="downloadPDF()" class="bg-red-600 text-white px-6 py-3 rounded-lg hover:bg-red-700 transition duration-200 flex items-center justify-center">
                                <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                                </svg>
                                Download PDF
                            </button>
                            <button onclick="downloadExcel()" class="bg-green-600 text-white px-6 py-3 rounded-lg hover:bg-green-700 transition duration-200 flex items-center justify-center">
                                <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                                </svg>
                                Download Excel
                            </button>
                            <button onclick="printReport()" class="bg-blue-600 text-white px-6 py-3 rounded-lg hover:bg-blue-700 transition duration-200 flex items-center justify-center">
                                <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 17h2a2 2 0 002-2v-4a2 2 0 00-2-2H5a2 2 0 00-2 2v4a2 2 0 002 2h2m2 4h6a2 2 0 002-2v-4a2 2 0 00-2-2H9a2 2 0 00-2 2v4a2 2 0 002 2zm8-12V5a2 2 0 00-2-2H9a2 2 0 00-2 2v4h10z"></path>
                                </svg>
                                Print
                            </button>
                        </div>
                    </div>
                </div>

                <!-- User Management -->
                <div id="userContent" class="hidden">
                    <div class="bg-white rounded-lg shadow-sm p-6">
                        <h3 class="text-lg font-semibold mb-4">User Management</h3>
                        <form id="userForm" class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Username</label>
                                <input type="text" id="userUsername" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Password</label>
                                <input type="password" id="userPassword" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                            </div>
                            <div class="md:col-span-2">
                                <button type="submit" class="bg-blue-600 text-white px-6 py-2 rounded-lg hover:bg-blue-700 transition duration-200">Tambah User</button>
                            </div>
                        </form>
                        
                        <div class="overflow-x-auto">
                            <table class="min-w-full bg-white border border-gray-200">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Username</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Aksi</th>
                                    </tr>
                                </thead>
                                <tbody id="userTable" class="bg-white divide-y divide-gray-200">
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <!-- Print Area -->
    <div class="print-area">
        <h1>Laporan Sistem Gudang</h1>
        <div id="printContent"></div>
    </div>

    <script>
        // ================================
        // KONFIGURASI SINKRONISASI 2 ARAH
        // ================================
        
        // Google Apps Script Web App Configuration
        let WEB_APP_URL = localStorage.getItem('webAppUrl') || '';
        let SYNC_MODE = localStorage.getItem('syncMode') || 'bidirectional';
        let isGoogleSheetsConnected = false;
        let syncInterval = null;
        let realtimeSyncEnabled = true;
        let lastSyncTime = null;
        let conflictCount = 0;
        let syncLog = [];

        // Data Storage dengan timestamp untuk deteksi perubahan
        let database = JSON.parse(localStorage.getItem('database')) || [];
        let outlets = JSON.parse(localStorage.getItem('outlets')) || [];
        let statusItems = JSON.parse(localStorage.getItem('statusItems')) || [];
        let riwayat = JSON.parse(localStorage.getItem('riwayat')) || [];
        let users = JSON.parse(localStorage.getItem('users')) || [
            { username: 'admin', password: 'admin123' }
        ];
        let currentUser = null;

        // Data checksums untuk deteksi perubahan
        let dataChecksums = {
            database: '',
            outlets: '',
            statusItems: '',
            riwayat: ''
        };

        // Conflict resolution data
        let currentConflict = null;

        // ================================
        // FUNGSI INISIALISASI
        // ================================

        document.addEventListener('DOMContentLoaded', function() {
            // Set today's date as default
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('penerimaanTanggal').value = today;
            document.getElementById('transferTanggal').value = today;
            
            // Setup event listeners
            setupEventListeners();
            
            // Load data
            loadOutletDropdown();
            loadTables();
            
            // Initialize checksums
            updateDataChecksums();
            
            // Auto-configure the provided URL if not already set
            if (!WEB_APP_URL && !localStorage.getItem('webAppUrl')) {
                WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbwRCFOgHDXSPu6QkuvRlpOMkLgCLQxGfc0RpJzemItW19FTVRWQDu3B9EjqL26Qum6B/exec';
                localStorage.setItem('webAppUrl', WEB_APP_URL);
                localStorage.setItem('syncMode', 'bidirectional');
                SYNC_MODE = 'bidirectional';
                addSyncLog('üîß Auto-konfigurasi URL Google Apps Script...');
            }
            
            // Initialize Google Sheets Web App if configured
            if (WEB_APP_URL) {
                initializeWebApp();
            } else {
                // Mode offline - sistem tetap berfungsi tanpa Google Sheets
                updateSyncStatus('disconnected');
                addSyncLog('üíæ Mode offline aktif - data tersimpan di browser');
                
                // Show setup reminder after 3 seconds
                setTimeout(() => {
                    if (!isGoogleSheetsConnected) {
                        const setupMessage = `
üíæ Sistem Gudang - Mode Offline

‚úÖ Sistem berfungsi normal tanpa Google Sheets
‚úÖ Data tersimpan aman di browser Anda
‚úÖ Semua fitur tersedia (input, laporan, dll)

üåü Upgrade ke Mode Online:
‚Ä¢ Sinkronisasi 2-arah real-time
‚Ä¢ Backup otomatis ke cloud
‚Ä¢ Akses dari multiple device
‚Ä¢ Kolaborasi tim

Apakah Anda ingin mengaktifkan Google Sheets sekarang?`;

                        if (confirm(setupMessage)) {
                            showSheetsSetup();
                        }
                    }
                }, 3000);
            }
        });

        // ================================
        // FUNGSI GOOGLE WEB APP 2-ARAH
        // ================================

        async function initializeWebApp() {
            try {
                addSyncLog('üîÑ Mencoba koneksi ke Google Apps Script...');
                
                // Method 1: Try JSONP first (best for CORS)
                const success = await tryJSONPConnection();
                if (success) {
                    isGoogleSheetsConnected = true;
                    updateSyncStatus('connected');
                    
                    // Sinkronisasi awal dari Sheets ke Website
                    await syncFromWebApp();
                    
                    // Mulai auto sync 2 arah
                    startBidirectionalSync();
                    
                    addSyncLog('‚úÖ Koneksi JSONP berhasil - Mode: ' + SYNC_MODE);
                    return;
                }
                
                // Method 2: Try regular fetch with no-cors
                const response = await fetch(WEB_APP_URL + '?action=ping', {
                    method: 'GET',
                    mode: 'no-cors'
                });
                
                // no-cors always returns opaque response, assume success if no error
                isGoogleSheetsConnected = true;
                updateSyncStatus('connected');
                
                // Try to sync data
                await syncFromWebApp();
                startBidirectionalSync();
                
                addSyncLog('‚úÖ Koneksi no-cors berhasil - Mode: ' + SYNC_MODE);
                
            } catch (error) {
                console.error('Error initializing Web App:', error);
                
                // Try one more method: direct script tag injection
                try {
                    await tryScriptTagMethod();
                    isGoogleSheetsConnected = true;
                    updateSyncStatus('connected');
                    addSyncLog('‚úÖ Koneksi script tag berhasil - Mode: ' + SYNC_MODE);
                } catch (scriptError) {
                    updateSyncStatus('disconnected');
                    addSyncLog('‚ùå Semua metode koneksi gagal. Sistem berjalan dalam mode offline.');
                    
                    // Show detailed error info
                    setTimeout(() => {
                        if (!isGoogleSheetsConnected) {
                            showConnectionTroubleshooting(error.message);
                        }
                    }, 2000);
                }
            }
        }

        function tryJSONPConnection() {
            return new Promise((resolve) => {
                const callbackName = 'jsonp_callback_' + Date.now();
                const script = document.createElement('script');
                const timeout = setTimeout(() => {
                    cleanup();
                    resolve(false);
                }, 10000);
                
                function cleanup() {
                    clearTimeout(timeout);
                    if (script.parentNode) {
                        script.parentNode.removeChild(script);
                    }
                    delete window[callbackName];
                }
                
                window[callbackName] = function(data) {
                    cleanup();
                    if (data && data.status === 'success') {
                        resolve(true);
                    } else {
                        resolve(false);
                    }
                };
                
                script.src = WEB_APP_URL + '?action=ping&callback=' + callbackName;
                script.onerror = () => {
                    cleanup();
                    resolve(false);
                };
                
                document.head.appendChild(script);
            });
        }

        function tryScriptTagMethod() {
            return new Promise((resolve, reject) => {
                const script = document.createElement('script');
                script.src = WEB_APP_URL + '?action=ping&callback=handleScriptResponse';
                
                window.handleScriptResponse = function(data) {
                    document.head.removeChild(script);
                    delete window.handleScriptResponse;
                    
                    if (data && data.status === 'success') {
                        resolve(true);
                    } else {
                        reject(new Error('Script response invalid'));
                    }
                };
                
                script.onerror = () => {
                    document.head.removeChild(script);
                    delete window.handleScriptResponse;
                    reject(new Error('Script load failed'));
                };
                
                setTimeout(() => {
                    if (script.parentNode) {
                        document.head.removeChild(script);
                        delete window.handleScriptResponse;
                        reject(new Error('Script timeout'));
                    }
                }, 10000);
                
                document.head.appendChild(script);
            });
        }

        function showConnectionTroubleshooting(errorMessage) {
            const troubleshootingMessage = `
üîß PANDUAN MENGATASI ERROR KONEKSI

‚ùå Error: ${errorMessage}

üìã SOLUSI LANGKAH DEMI LANGKAH:

1Ô∏è‚É£ CEK GOOGLE APPS SCRIPT:
   ‚Ä¢ Buka: ${WEB_APP_URL}
   ‚Ä¢ Pastikan muncul response JSON (bukan error page)
   ‚Ä¢ Jika error 404: URL salah atau script belum di-deploy

2Ô∏è‚É£ CEK DEPLOYMENT SETTINGS:
   ‚Ä¢ Di Apps Script: Deploy ‚Üí Manage deployments
   ‚Ä¢ Execute as: "Me" 
   ‚Ä¢ Who has access: "Anyone" ‚Üê PENTING!
   ‚Ä¢ Jika masih "Anyone with Google account", ubah ke "Anyone"

3Ô∏è‚É£ CEK KODE APPS SCRIPT:
   ‚Ä¢ Pastikan ada function doGet()
   ‚Ä¢ Pastikan ada support untuk JSONP callback
   ‚Ä¢ Copy ulang kode dari setup modal jika perlu

4Ô∏è‚É£ BROWSER ISSUES:
   ‚Ä¢ Coba refresh halaman (Ctrl+F5)
   ‚Ä¢ Coba browser lain (Chrome/Firefox)
   ‚Ä¢ Disable ad blocker sementara
   ‚Ä¢ Coba mode incognito

5Ô∏è‚É£ NETWORK ISSUES:
   ‚Ä¢ Cek koneksi internet
   ‚Ä¢ Coba jaringan lain (mobile hotspot)
   ‚Ä¢ Firewall/proxy mungkin memblokir

üí° TIPS:
‚Ä¢ Sistem tetap berfungsi 100% tanpa Google Sheets
‚Ä¢ Data tersimpan aman di browser
‚Ä¢ Setup Google Sheets opsional untuk backup & kolaborasi

Apakah Anda ingin mencoba setup ulang Google Apps Script?`;

            if (confirm(troubleshootingMessage)) {
                showSheetsSetup();
            }
        }

        async function setupSpreadsheetIfNeeded() {
            try {
                const response = await fetch(WEB_APP_URL, {
                    method: 'POST',
                    mode: 'cors',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        action: 'setup',
                        data: {
                            title: 'Sistem Gudang - ' + new Date().toLocaleDateString('id-ID')
                        }
                    })
                });
                
                const result = await response.json();
                if (result.status === 'success') {
                    addSyncLog('‚úÖ Spreadsheet berhasil disetup');
                }
            } catch (error) {
                console.error('Error setting up spreadsheet:', error);
                addSyncLog('‚ö†Ô∏è Warning: Setup spreadsheet gagal');
            }
        }

        async function syncFromWebApp() {
            try {
                // Try JSONP method first
                const jsonpData = await fetchDataViaJSONP('getAllData');
                if (jsonpData && jsonpData.status === 'success' && jsonpData.data) {
                    updateLocalDataFromRemote(jsonpData.data);
                    addSyncLog('üì• Data berhasil disinkronkan dari Sheets (JSONP)');
                    return;
                }
                
                // Fallback to regular fetch
                const response = await fetch(WEB_APP_URL + '?action=getAllData', {
                    method: 'GET',
                    mode: 'no-cors'
                });
                
                // For no-cors, we can't read the response, so assume success if no error
                addSyncLog('üì• Sync request sent to Sheets (no-cors mode)');
                
            } catch (error) {
                console.error('Error syncing from Web App:', error);
                addSyncLog('‚ùå Error sync dari Sheets: ' + error.message);
                
                // Don't throw error - let system continue in offline mode
            }
        }

        function fetchDataViaJSONP(action, params = {}) {
            return new Promise((resolve) => {
                const callbackName = 'jsonp_sync_' + Date.now();
                const script = document.createElement('script');
                
                // Build URL with parameters
                const urlParams = new URLSearchParams({
                    action: action,
                    callback: callbackName,
                    ...params
                });
                
                const timeout = setTimeout(() => {
                    cleanup();
                    resolve(null);
                }, 15000);
                
                function cleanup() {
                    clearTimeout(timeout);
                    if (script.parentNode) {
                        script.parentNode.removeChild(script);
                    }
                    delete window[callbackName];
                }
                
                window[callbackName] = function(data) {
                    cleanup();
                    resolve(data);
                };
                
                script.src = WEB_APP_URL + '?' + urlParams.toString();
                script.onerror = () => {
                    cleanup();
                    resolve(null);
                };
                
                document.head.appendChild(script);
            });
        }

        function updateLocalDataFromRemote(remoteData) {
            try {
                // Update local data dengan data dari spreadsheet
                if (remoteData.database && Array.isArray(remoteData.database)) {
                    database = remoteData.database;
                    localStorage.setItem('database', JSON.stringify(database));
                }
                if (remoteData.outlets && Array.isArray(remoteData.outlets)) {
                    outlets = remoteData.outlets;
                    localStorage.setItem('outlets', JSON.stringify(outlets));
                }
                if (remoteData.statusItems && Array.isArray(remoteData.statusItems)) {
                    statusItems = remoteData.statusItems;
                    localStorage.setItem('statusItems', JSON.stringify(statusItems));
                }
                if (remoteData.riwayat && Array.isArray(remoteData.riwayat)) {
                    riwayat = remoteData.riwayat;
                    localStorage.setItem('riwayat', JSON.stringify(riwayat));
                }
                
                // Reload UI
                loadTables();
                loadOutletDropdown();
                updateDataChecksums();
                
            } catch (error) {
                console.error('Error updating local data:', error);
                addSyncLog('‚ùå Error updating local data: ' + error.message);
            }
        }

        // ================================
        // FUNGSI SINKRONISASI 2-ARAH
        // ================================

        function startBidirectionalSync() {
            if (syncInterval) clearInterval(syncInterval);
            
            if (!realtimeSyncEnabled || SYNC_MODE === 'manual') return;
            
            // Sync setiap 5 detik untuk real-time experience
            syncInterval = setInterval(async () => {
                if (isGoogleSheetsConnected && realtimeSyncEnabled) {
                    await performBidirectionalSync();
                }
            }, 5000);
            
            document.getElementById('realtimeIndicator').classList.remove('hidden');
            addSyncLog('üîÑ Sinkronisasi real-time dimulai (interval: 5 detik)');
        }

        async function performBidirectionalSync() {
            try {
                updateSyncStatus('syncing');
                
                // 1. Cek perubahan lokal
                const localChanges = detectLocalChanges();
                
                // 2. Cek perubahan di Google Sheets
                const remoteChanges = await detectRemoteChanges();
                
                // 3. Handle conflicts jika ada
                if (localChanges.length > 0 && remoteChanges.length > 0) {
                    await handleConflicts(localChanges, remoteChanges);
                } else {
                    // 4. Sync perubahan lokal ke Sheets
                    if (localChanges.length > 0 && (SYNC_MODE === 'bidirectional' || SYNC_MODE === 'websiteToSheets')) {
                        await syncLocalChangesToSheets(localChanges);
                        addSyncLog(`üì§ ${localChanges.length} perubahan lokal disinkronkan ke Sheets`);
                    }
                    
                    // 5. Sync perubahan Sheets ke lokal
                    if (remoteChanges.length > 0 && (SYNC_MODE === 'bidirectional' || SYNC_MODE === 'sheetsToWebsite')) {
                        await syncRemoteChangesToLocal(remoteChanges);
                        addSyncLog(`üì• ${remoteChanges.length} perubahan dari Sheets disinkronkan ke lokal`);
                    }
                }
                
                lastSyncTime = new Date();
                updateSyncStatus('connected');
                
            } catch (error) {
                console.error('Error in bidirectional sync:', error);
                updateSyncStatus('disconnected');
                addSyncLog('‚ùå Error sync: ' + error.message);
            }
        }

        function detectLocalChanges() {
            const changes = [];
            
            // Check database changes
            const currentDatabaseChecksum = generateChecksum(database);
            if (currentDatabaseChecksum !== dataChecksums.database) {
                changes.push({ type: 'database', data: database });
                dataChecksums.database = currentDatabaseChecksum;
            }
            
            // Check outlets changes
            const currentOutletsChecksum = generateChecksum(outlets);
            if (currentOutletsChecksum !== dataChecksums.outlets) {
                changes.push({ type: 'outlets', data: outlets });
                dataChecksums.outlets = currentOutletsChecksum;
            }
            
            // Check status changes
            const currentStatusChecksum = generateChecksum(statusItems);
            if (currentStatusChecksum !== dataChecksums.statusItems) {
                changes.push({ type: 'statusItems', data: statusItems });
                dataChecksums.statusItems = currentStatusChecksum;
            }
            
            // Check riwayat changes
            const currentRiwayatChecksum = generateChecksum(riwayat);
            if (currentRiwayatChecksum !== dataChecksums.riwayat) {
                changes.push({ type: 'riwayat', data: riwayat });
                dataChecksums.riwayat = currentRiwayatChecksum;
            }
            
            return changes;
        }

        async function detectRemoteChanges() {
            try {
                const response = await fetch(WEB_APP_URL + '?action=getChecksums', {
                    method: 'GET',
                    mode: 'cors'
                });
                
                if (!response.ok) return [];
                
                const result = await response.json();
                if (result.status !== 'success') return [];
                
                const changes = [];
                const remoteChecksums = result.data || {};
                
                // Check each data type for changes
                for (const [dataType, remoteChecksum] of Object.entries(remoteChecksums)) {
                    const localChecksum = dataChecksums[dataType];
                    if (remoteChecksum && remoteChecksum !== localChecksum) {
                        // Get the actual data
                        const sheetData = await getWebAppData(dataType);
                        changes.push({ type: dataType, data: sheetData, checksum: remoteChecksum });
                    }
                }
                
                return changes;
                
            } catch (error) {
                console.error('Error detecting remote changes:', error);
                return [];
            }
        }

        async function getWebAppData(dataType) {
            try {
                const response = await fetch(WEB_APP_URL + `?action=getData&type=${dataType}`, {
                    method: 'GET',
                    mode: 'cors'
                });
                
                if (response.ok) {
                    const result = await response.json();
                    if (result.status === 'success') {
                        return result.data || [];
                    }
                }
                return [];
            } catch (error) {
                console.error('Error getting Web App data:', error);
                return [];
            }
        }

        async function handleConflicts(localChanges, remoteChanges) {
            // Find conflicting changes
            const conflicts = [];
            
            localChanges.forEach(localChange => {
                const remoteChange = remoteChanges.find(rc => rc.type === localChange.type);
                if (remoteChange) {
                    conflicts.push({
                        type: localChange.type,
                        local: localChange.data,
                        remote: remoteChange.data
                    });
                }
            });
            
            if (conflicts.length > 0) {
                conflictCount += conflicts.length;
                updateSyncStatus('conflict');
                
                // Show conflict resolution modal for the first conflict
                await showConflictResolution(conflicts[0]);
            }
        }

        function showConflictResolution(conflict) {
            return new Promise((resolve) => {
                currentConflict = { conflict, resolve };
                
                // Populate conflict modal
                document.getElementById('localVersion').innerHTML = formatConflictData(conflict.local);
                document.getElementById('cloudVersion').innerHTML = formatConflictData(conflict.remote);
                
                // Show modal
                document.getElementById('conflictModal').classList.remove('hidden');
                
                addSyncLog(`‚ö†Ô∏è Konflik terdeteksi pada ${conflict.type}`);
            });
        }

        function formatConflictData(data) {
            if (Array.isArray(data)) {
                return `${data.length} items - Last item: ${JSON.stringify(data[data.length - 1] || {})}`;
            }
            return JSON.stringify(data);
        }

        async function resolveConflict(resolution) {
            if (!currentConflict) return;
            
            const { conflict, resolve } = currentConflict;
            
            try {
                switch (resolution) {
                    case 'local':
                        // Use local version, sync to remote
                        await syncDataToSheet(conflict.type, conflict.local);
                        addSyncLog(`‚úÖ Konflik ${conflict.type} diselesaikan: menggunakan versi lokal`);
                        break;
                        
                    case 'cloud':
                        // Use remote version, update local
                        updateLocalData(conflict.type, conflict.remote);
                        addSyncLog(`‚úÖ Konflik ${conflict.type} diselesaikan: menggunakan versi cloud`);
                        break;
                        
                    case 'merge':
                        // Merge both versions
                        const merged = mergeData(conflict.local, conflict.remote);
                        updateLocalData(conflict.type, merged);
                        await syncDataToSheet(conflict.type, merged);
                        addSyncLog(`‚úÖ Konflik ${conflict.type} diselesaikan: data digabungkan`);
                        break;
                }
                
                closeConflictModal();
                resolve();
                
            } catch (error) {
                console.error('Error resolving conflict:', error);
                addSyncLog(`‚ùå Error menyelesaikan konflik: ${error.message}`);
            }
        }

        function mergeData(local, remote) {
            // Simple merge strategy: combine arrays and remove duplicates
            if (Array.isArray(local) && Array.isArray(remote)) {
                const combined = [...local, ...remote];
                // Remove duplicates based on first column (usually ID/code)
                const unique = combined.filter((item, index, arr) => 
                    arr.findIndex(i => i[0] === item[0]) === index
                );
                return unique;
            }
            return local; // Fallback to local
        }

        function closeConflictModal() {
            document.getElementById('conflictModal').classList.add('hidden');
            currentConflict = null;
        }

        // ================================
        // FUNGSI SYNC UTILITIES
        // ================================

        async function syncLocalChangesToSheets(changes) {
            for (const change of changes) {
                await syncDataToSheet(change.type, change.data);
            }
        }

        async function syncRemoteChangesToLocal(changes) {
            for (const change of changes) {
                updateLocalData(change.type, change.data);
                dataChecksums[change.type] = change.checksum;
            }
            
            // Reload UI
            loadTables();
            loadOutletDropdown();
            
            // Highlight changed data
            highlightChangedData();
        }

        async function syncDataToSheet(dataType, data) {
            try {
                const response = await fetch(WEB_APP_URL, {
                    method: 'POST',
                    mode: 'cors',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        action: 'updateData',
                        type: dataType,
                        data: data,
                        checksum: generateChecksum(data)
                    })
                });
                
                if (response.ok) {
                    const result = await response.json();
                    if (result.status === 'success') {
                        addSyncLog(`üì§ ${dataType} berhasil disinkronkan ke Sheets`);
                    } else {
                        throw new Error(result.message || 'Sync gagal');
                    }
                } else {
                    throw new Error('HTTP Error: ' + response.status);
                }
                
            } catch (error) {
                console.error('Error syncing data to sheet:', error);
                addSyncLog(`‚ùå Error sync ${dataType}: ${error.message}`);
                throw error;
            }
        }

        function updateLocalData(dataType, remoteData) {
            const parsers = {
                'database': (rows) => rows.map(row => ({
                    kode: row[0] || '',
                    nama: row[1] || '',
                    stock: parseInt(row[2]) || 0,
                    unit: row[3] || ''
                })),
                'outlets': (rows) => rows.map(row => ({
                    kode: row[0] || '',
                    nama: row[1] || ''
                })),
                'statusItems': (rows) => rows.map(row => ({
                    kode: row[0] || '',
                    nama: row[1] || '',
                    status: row[2] || ''
                })),
                'riwayat': (rows) => rows.map(row => ({
                    tanggal: row[0] || '',
                    kode: row[1] || '',
                    nama: row[2] || '',
                    keterangan: row[3] || ''
                }))
            };
            
            const parsedData = parsers[dataType](remoteData);
            
            switch (dataType) {
                case 'database':
                    database = parsedData;
                    localStorage.setItem('database', JSON.stringify(database));
                    break;
                case 'outlets':
                    outlets = parsedData;
                    localStorage.setItem('outlets', JSON.stringify(outlets));
                    break;
                case 'statusItems':
                    statusItems = parsedData;
                    localStorage.setItem('statusItems', JSON.stringify(statusItems));
                    break;
                case 'riwayat':
                    riwayat = parsedData;
                    localStorage.setItem('riwayat', JSON.stringify(riwayat));
                    break;
            }
        }

        // Metadata update is handled by Web App automatically

        // ================================
        // FUNGSI UTILITY
        // ================================

        function generateChecksum(data) {
            return btoa(JSON.stringify(data)).slice(0, 16);
        }

        function updateDataChecksums() {
            dataChecksums.database = generateChecksum(database);
            dataChecksums.outlets = generateChecksum(outlets);
            dataChecksums.statusItems = generateChecksum(statusItems);
            dataChecksums.riwayat = generateChecksum(riwayat);
        }

        function highlightChangedData() {
            // Add highlight class to recently changed rows
            setTimeout(() => {
                document.querySelectorAll('tbody tr').forEach(row => {
                    row.classList.add('data-changed');
                    setTimeout(() => row.classList.remove('data-changed'), 2000);
                });
            }, 100);
        }

        function addSyncLog(message) {
            const timestamp = new Date().toLocaleTimeString('id-ID');
            syncLog.unshift(`[${timestamp}] ${message}`);
            
            // Keep only last 50 logs
            if (syncLog.length > 50) {
                syncLog = syncLog.slice(0, 50);
            }
            
            // Update log display if modal is open
            const logElement = document.getElementById('syncLog');
            if (logElement) {
                logElement.innerHTML = syncLog.map(log => `<div>${log}</div>`).join('');
            }
        }

        // ================================
        // FUNGSI UI CONTROLS
        // ================================

        function showSheetsSetup() {
            document.getElementById('sheetsSetupModal').classList.remove('hidden');
            document.getElementById('webAppUrl').value = WEB_APP_URL;
            document.getElementById('syncModeSelect').value = SYNC_MODE;
        }

        function closeSetupModal() {
            document.getElementById('sheetsSetupModal').classList.add('hidden');
        }

        async function setupGoogleSheets() {
            const webAppUrl = document.getElementById('webAppUrl').value.trim();
            const syncMode = document.getElementById('syncModeSelect').value;

            if (!webAppUrl) {
                alert('Web App URL harus diisi!');
                return;
            }

            if (!webAppUrl.includes('script.google.com')) {
                alert('URL harus berupa Google Apps Script Web App URL!');
                return;
            }

            WEB_APP_URL = webAppUrl;
            SYNC_MODE = syncMode;

            localStorage.setItem('webAppUrl', WEB_APP_URL);
            localStorage.setItem('syncMode', SYNC_MODE);

            closeSetupModal();
            
            try {
                await initializeWebApp();
                alert('Google Apps Script Web App berhasil dikonfigurasi dengan mode: ' + syncMode);
            } catch (error) {
                alert('Error: ' + error.message);
            }
        }

        function showSyncDetails() {
            document.getElementById('syncDetailsModal').classList.remove('hidden');
            
            // Update status info
            document.getElementById('connectionStatus').textContent = isGoogleSheetsConnected ? 'Terhubung' : 'Terputus';
            document.getElementById('lastSyncTime').textContent = lastSyncTime ? lastSyncTime.toLocaleString('id-ID') : 'Belum pernah';
            document.getElementById('conflictCount').textContent = conflictCount;
            
            // Update log
            const logElement = document.getElementById('syncLog');
            logElement.innerHTML = syncLog.map(log => `<div>${log}</div>`).join('');
        }

        function closeSyncDetails() {
            document.getElementById('syncDetailsModal').classList.add('hidden');
        }

        async function forceBidirectionalSync() {
            if (!isGoogleSheetsConnected) {
                if (confirm('Google Sheets belum terkonfigurasi!\n\nApakah Anda ingin mengatur sekarang?')) {
                    showSheetsSetup();
                }
                return;
            }
            
            addSyncLog('üîÑ Force sync dimulai...');
            await performBidirectionalSync();
            alert('Sinkronisasi 2-arah selesai!');
        }

        function toggleRealtimeSync() {
            realtimeSyncEnabled = !realtimeSyncEnabled;
            const btn = document.getElementById('toggleSyncBtn');
            
            if (realtimeSyncEnabled) {
                startBidirectionalSync();
                btn.textContent = '‚è∏Ô∏è Pause';
                btn.classList.remove('bg-red-600', 'hover:bg-red-700');
                btn.classList.add('bg-green-600', 'hover:bg-green-700');
                document.getElementById('realtimeIndicator').classList.remove('hidden');
                addSyncLog('‚ñ∂Ô∏è Real-time sync diaktifkan');
            } else {
                if (syncInterval) clearInterval(syncInterval);
                btn.textContent = '‚ñ∂Ô∏è Resume';
                btn.classList.remove('bg-green-600', 'hover:bg-green-700');
                btn.classList.add('bg-red-600', 'hover:bg-red-700');
                document.getElementById('realtimeIndicator').classList.add('hidden');
                addSyncLog('‚è∏Ô∏è Real-time sync dinonaktifkan');
            }
        }

        function updateSyncStatus(status) {
            const indicator = document.getElementById('syncStatus');
            const setupBtn = document.getElementById('setupSheetsBtn');
            
            switch (status) {
                case 'connected':
                    indicator.className = 'sync-indicator sync-connected';
                    indicator.innerHTML = '‚úÖ Sync 2-Arah Aktif';
                    if (setupBtn) setupBtn.style.display = 'none';
                    break;
                case 'syncing':
                    indicator.className = 'sync-indicator sync-syncing';
                    indicator.innerHTML = 'üîÑ Sinkronisasi...';
                    break;
                case 'conflict':
                    indicator.className = 'sync-indicator sync-conflict';
                    indicator.innerHTML = '‚ö†Ô∏è Konflik Terdeteksi';
                    break;
                case 'disconnected':
                    indicator.className = 'sync-indicator sync-disconnected';
                    indicator.innerHTML = '‚ö†Ô∏è Tidak Terhubung';
                    if (setupBtn) setupBtn.style.display = 'flex';
                    break;
            }
        }

        // ================================
        // FUNGSI LAINNYA (SAMA SEPERTI SEBELUMNYA)
        // ================================

        // Authentication
        function login() {
            const username = document.getElementById('loginUsername').value;
            const password = document.getElementById('loginPassword').value;
            
            const user = users.find(u => u.username === username && u.password === password);
            
            if (user) {
                currentUser = user;
                document.getElementById('loginModal').classList.add('hidden');
                document.getElementById('mainContainer').classList.remove('hidden');
                showMenu('penerimaan');
            } else {
                document.getElementById('loginError').textContent = 'Username atau password salah';
                document.getElementById('loginError').classList.remove('hidden');
            }
        }

        function logout() {
            currentUser = null;
            document.getElementById('loginModal').classList.remove('hidden');
            document.getElementById('mainContainer').classList.add('hidden');
            document.getElementById('loginUsername').value = '';
            document.getElementById('loginPassword').value = '';
            document.getElementById('loginError').classList.add('hidden');
        }

        // Setup Event Listeners
        function setupEventListeners() {
            // Login form
            document.getElementById('loginForm').addEventListener('submit', function(e) {
                e.preventDefault();
                login();
            });

            // Sidebar toggle
            document.getElementById('toggleSidebar').addEventListener('click', function() {
                const sidebar = document.getElementById('sidebar');
                const mainContent = document.getElementById('mainContent');
                
                if (sidebar.classList.contains('sidebar-expanded')) {
                    sidebar.classList.remove('sidebar-expanded');
                    sidebar.classList.add('sidebar-collapsed');
                    mainContent.classList.remove('ml-64');
                    mainContent.classList.add('ml-16');
                } else {
                    sidebar.classList.remove('sidebar-collapsed');
                    sidebar.classList.add('sidebar-expanded');
                    mainContent.classList.remove('ml-16');
                    mainContent.classList.add('ml-64');
                }
            });

            // Auto-fill functionality for penerimaan
            document.getElementById('penerimaanKode').addEventListener('input', function() {
                const kode = this.value;
                const item = database.find(d => d.kode === kode);
                
                if (item) {
                    document.getElementById('penerimaanNama').value = item.nama;
                    document.getElementById('penerimaanUnit').value = item.unit;
                } else {
                    document.getElementById('penerimaanNama').value = '';
                    document.getElementById('penerimaanUnit').value = '';
                }
            });

            // Auto-fill functionality for transfer
            document.getElementById('transferKode').addEventListener('input', function() {
                const kode = this.value;
                const item = database.find(d => d.kode === kode);
                
                if (item) {
                    document.getElementById('transferNama').value = item.nama;
                    document.getElementById('transferUnit').value = item.unit;
                } else {
                    document.getElementById('transferNama').value = '';
                    document.getElementById('transferUnit').value = '';
                }
            });

            // Form submissions
            document.getElementById('penerimaanForm').addEventListener('submit', handlePenerimaan);
            document.getElementById('transferForm').addEventListener('submit', handleTransfer);
            document.getElementById('outletForm').addEventListener('submit', handleOutlet);
            document.getElementById('userForm').addEventListener('submit', handleUser);
        }

        // Menu Navigation
        function showMenu(menu) {
            // Hide all content
            const contents = ['penerimaan', 'transfer', 'outlet', 'status', 'database', 'riwayat', 'laporan', 'user'];
            contents.forEach(content => {
                document.getElementById(content + 'Content').classList.add('hidden');
            });

            // Show selected content
            document.getElementById(menu + 'Content').classList.remove('hidden');
            
            // Update page title
            const titles = {
                'penerimaan': 'Penerimaan Barang',
                'transfer': 'Transfer Barang',
                'outlet': 'Data Outlet',
                'status': 'Status Barang',
                'database': 'Database Barang',
                'riwayat': 'Riwayat Transaksi',
                'laporan': 'Laporan',
                'user': 'User Management'
            };
            document.getElementById('pageTitle').textContent = titles[menu];
        }

        // Handle Penerimaan
        async function handlePenerimaan(e) {
            e.preventDefault();
            
            const data = {
                tanggal: document.getElementById('penerimaanTanggal').value,
                kode: document.getElementById('penerimaanKode').value,
                nama: document.getElementById('penerimaanNama').value,
                qty: parseInt(document.getElementById('penerimaanQty').value),
                unit: document.getElementById('penerimaanUnit').value,
                status: document.getElementById('penerimaanStatus').value
            };

            if (data.status === 'Diterima') {
                // Add to database
                const existingItem = database.find(d => d.kode === data.kode);
                if (existingItem) {
                    existingItem.stock += data.qty;
                } else {
                    database.push({
                        kode: data.kode,
                        nama: data.nama,
                        stock: data.qty,
                        unit: data.unit
                    });
                }
                localStorage.setItem('database', JSON.stringify(database));
            } else {
                // Add to status
                statusItems.push({
                    kode: data.kode,
                    nama: data.nama,
                    status: data.status,
                    qty: data.qty,
                    unit: data.unit,
                    tanggal: data.tanggal
                });
                localStorage.setItem('statusItems', JSON.stringify(statusItems));
            }

            // Add to riwayat
            riwayat.push({
                tanggal: data.tanggal,
                kode: data.kode,
                nama: data.nama,
                keterangan: `Penerimaan - ${data.status} (${data.qty} ${data.unit})`
            });
            localStorage.setItem('riwayat', JSON.stringify(riwayat));

            // Reset form and reload tables
            document.getElementById('penerimaanForm').reset();
            document.getElementById('penerimaanTanggal').value = new Date().toISOString().split('T')[0];
            loadTables();
            
            // Update checksums untuk trigger sync
            updateDataChecksums();
            
            alert('Data penerimaan berhasil disimpan!');
        }

        // Handle Transfer
        async function handleTransfer(e) {
            e.preventDefault();
            
            const data = {
                tanggal: document.getElementById('transferTanggal').value,
                kode: document.getElementById('transferKode').value,
                nama: document.getElementById('transferNama').value,
                qty: parseInt(document.getElementById('transferQty').value),
                unit: document.getElementById('transferUnit').value,
                outlet: document.getElementById('transferOutlet').value
            };

            // Check if item exists in database
            const item = database.find(d => d.kode === data.kode);
            if (!item) {
                alert('Barang tidak ditemukan di database!');
                return;
            }

            if (item.stock < data.qty) {
                alert('Stock tidak mencukupi!');
                return;
            }

            // Update stock
            item.stock -= data.qty;
            localStorage.setItem('database', JSON.stringify(database));

            // Add to riwayat
            const outletName = outlets.find(o => o.kode === data.outlet)?.nama || data.outlet;
            riwayat.push({
                tanggal: data.tanggal,
                kode: data.kode,
                nama: data.nama,
                keterangan: `Transfer ke ${outletName} (${data.qty} ${data.unit})`
            });
            localStorage.setItem('riwayat', JSON.stringify(riwayat));

            // Reset form and reload tables
            document.getElementById('transferForm').reset();
            document.getElementById('transferTanggal').value = new Date().toISOString().split('T')[0];
            loadTables();
            
            // Update checksums untuk trigger sync
            updateDataChecksums();
            
            alert('Transfer berhasil!');
        }

        // Handle Outlet
        async function handleOutlet(e) {
            e.preventDefault();
            
            const data = {
                kode: document.getElementById('outletKode').value,
                nama: document.getElementById('outletNama').value
            };

            // Check if outlet already exists
            if (outlets.find(o => o.kode === data.kode)) {
                alert('Kode outlet sudah ada!');
                return;
            }

            outlets.push(data);
            localStorage.setItem('outlets', JSON.stringify(outlets));

            // Reset form and reload
            document.getElementById('outletForm').reset();
            loadOutletDropdown();
            loadTables();
            
            // Update checksums untuk trigger sync
            updateDataChecksums();
            
            alert('Outlet berhasil ditambahkan!');
        }

        // Handle User
        function handleUser(e) {
            e.preventDefault();
            
            const data = {
                username: document.getElementById('userUsername').value,
                password: document.getElementById('userPassword').value
            };

            // Check if user already exists
            if (users.find(u => u.username === data.username)) {
                alert('Username sudah ada!');
                return;
            }

            users.push(data);
            localStorage.setItem('users', JSON.stringify(users));

            // Reset form and reload
            document.getElementById('userForm').reset();
            loadTables();
            
            alert('User berhasil ditambahkan!');
        }

        // Load Outlet Dropdown
        function loadOutletDropdown() {
            const select = document.getElementById('transferOutlet');
            select.innerHTML = '<option value="">Pilih Outlet</option>';
            
            outlets.forEach(outlet => {
                const option = document.createElement('option');
                option.value = outlet.kode;
                option.textContent = `${outlet.kode} - ${outlet.nama}`;
                select.appendChild(option);
            });
        }

        // Load Tables
        function loadTables() {
            loadOutletTable();
            loadStatusTable();
            loadDatabaseTable();
            loadRiwayatTable();
            loadUserTable();
        }

        function loadOutletTable() {
            const tbody = document.getElementById('outletTable');
            tbody.innerHTML = '';
            
            outlets.forEach((outlet, index) => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${outlet.kode}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${outlet.nama}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                        <button onclick="deleteOutlet(${index})" class="text-red-600 hover:text-red-900">Hapus</button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        function loadStatusTable() {
            const tbody = document.getElementById('statusTable');
            tbody.innerHTML = '';
            
            statusItems.forEach((item, index) => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${item.kode}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${item.nama}</td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${item.status === 'Pending' ? 'bg-yellow-100 text-yellow-800' : 'bg-red-100 text-red-800'}">
                            ${item.status}
                        </span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                        <button onclick="approveStatus(${index})" class="text-green-600 hover:text-green-900 mr-2">Terima</button>
                        <button onclick="deleteStatus(${index})" class="text-red-600 hover:text-red-900">Hapus</button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        function loadDatabaseTable() {
            const tbody = document.getElementById('databaseTable');
            tbody.innerHTML = '';
            
            database.forEach((item, index) => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${item.kode}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${item.nama}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${item.stock}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${item.unit}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                        <button onclick="editDatabase(${index})" class="text-blue-600 hover:text-blue-900 mr-2">Edit</button>
                        <button onclick="deleteDatabase(${index})" class="text-red-600 hover:text-red-900">Hapus</button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        function loadRiwayatTable() {
            const tbody = document.getElementById('riwayatTable');
            tbody.innerHTML = '';
            
            riwayat.forEach(item => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${item.tanggal}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${item.kode}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${item.nama}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${item.keterangan}</td>
                `;
                tbody.appendChild(row);
            });
        }

        function loadUserTable() {
            const tbody = document.getElementById('userTable');
            tbody.innerHTML = '';
            
            users.forEach((user, index) => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${user.username}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                        <button onclick="editUser(${index})" class="text-blue-600 hover:text-blue-900 mr-2">Edit</button>
                        ${user.username !== 'admin' ? `<button onclick="deleteUser(${index})" class="text-red-600 hover:text-red-900">Hapus</button>` : ''}
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        // Delete Functions
        async function deleteOutlet(index) {
            if (confirm('Yakin ingin menghapus outlet ini?')) {
                outlets.splice(index, 1);
                localStorage.setItem('outlets', JSON.stringify(outlets));
                loadOutletDropdown();
                loadTables();
                updateDataChecksums();
            }
        }

        async function deleteStatus(index) {
            if (confirm('Yakin ingin menghapus status ini?')) {
                statusItems.splice(index, 1);
                localStorage.setItem('statusItems', JSON.stringify(statusItems));
                loadTables();
                updateDataChecksums();
            }
        }

        async function deleteDatabase(index) {
            if (confirm('Yakin ingin menghapus barang ini?')) {
                database.splice(index, 1);
                localStorage.setItem('database', JSON.stringify(database));
                loadTables();
                updateDataChecksums();
            }
        }

        function deleteUser(index) {
            if (confirm('Yakin ingin menghapus user ini?')) {
                users.splice(index, 1);
                localStorage.setItem('users', JSON.stringify(users));
                loadTables();
            }
        }

        // Approve Status
        async function approveStatus(index) {
            const item = statusItems[index];
            
            // Add to database
            const existingItem = database.find(d => d.kode === item.kode);
            if (existingItem) {
                existingItem.stock += item.qty;
            } else {
                database.push({
                    kode: item.kode,
                    nama: item.nama,
                    stock: item.qty,
                    unit: item.unit
                });
            }
            
            // Add to riwayat
            riwayat.push({
                tanggal: new Date().toISOString().split('T')[0],
                kode: item.kode,
                nama: item.nama,
                keterangan: `Status diubah menjadi Diterima (${item.qty} ${item.unit})`
            });
            
            // Remove from status
            statusItems.splice(index, 1);
            
            // Save to localStorage
            localStorage.setItem('database', JSON.stringify(database));
            localStorage.setItem('statusItems', JSON.stringify(statusItems));
            localStorage.setItem('riwayat', JSON.stringify(riwayat));
            
            loadTables();
            updateDataChecksums();
            
            alert('Status berhasil diubah menjadi Diterima!');
        }

        // Edit Functions
        async function editDatabase(index) {
            const item = database[index];
            const newStock = prompt('Masukkan stock baru:', item.stock);
            
            if (newStock !== null && !isNaN(newStock)) {
                item.stock = parseInt(newStock);
                localStorage.setItem('database', JSON.stringify(database));
                loadTables();
                updateDataChecksums();
            }
        }

        function editUser(index) {
            const user = users[index];
            const newPassword = prompt('Masukkan password baru:');
            
            if (newPassword !== null && newPassword.trim() !== '') {
                user.password = newPassword.trim();
                localStorage.setItem('users', JSON.stringify(users));
                alert('Password berhasil diubah!');
            }
        }

        // Report Functions
        function downloadPDF() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            doc.setFontSize(16);
            doc.text('Laporan Sistem Gudang', 20, 20);
            
            let y = 40;
            
            // Database Report
            doc.setFontSize(12);
            doc.text('Database Barang:', 20, y);
            y += 10;
            
            database.forEach(item => {
                doc.text(`${item.kode} - ${item.nama}: ${item.stock} ${item.unit}`, 20, y);
                y += 8;
            });
            
            y += 10;
            doc.text('Riwayat Transaksi:', 20, y);
            y += 10;
            
            riwayat.slice(-10).forEach(item => {
                doc.text(`${item.tanggal} - ${item.kode}: ${item.keterangan}`, 20, y);
                y += 8;
                if (y > 280) {
                    doc.addPage();
                    y = 20;
                }
            });
            
            doc.save('laporan-gudang.pdf');
        }

        function downloadExcel() {
            const wb = XLSX.utils.book_new();
            
            // Database sheet
            const dbWs = XLSX.utils.json_to_sheet(database);
            XLSX.utils.book_append_sheet(wb, dbWs, 'Database');
            
            // Riwayat sheet
            const riwayatWs = XLSX.utils.json_to_sheet(riwayat);
            XLSX.utils.book_append_sheet(wb, riwayatWs, 'Riwayat');
            
            // Outlet sheet
            const outletWs = XLSX.utils.json_to_sheet(outlets);
            XLSX.utils.book_append_sheet(wb, outletWs, 'Outlet');
            
            XLSX.writeFile(wb, 'laporan-gudang.xlsx');
        }

        function printReport() {
            const printContent = document.getElementById('printContent');
            
            let html = '<h2>Database Barang</h2><table border="1" style="width:100%; border-collapse: collapse;"><tr><th>Kode</th><th>Nama</th><th>Stock</th><th>Unit</th></tr>';
            database.forEach(item => {
                html += `<tr><td>${item.kode}</td><td>${item.nama}</td><td>${item.stock}</td><td>${item.unit}</td></tr>`;
            });
            html += '</table><br>';
            
            html += '<h2>Riwayat Transaksi</h2><table border="1" style="width:100%; border-collapse: collapse;"><tr><th>Tanggal</th><th>Kode</th><th>Nama</th><th>Keterangan</th></tr>';
            riwayat.forEach(item => {
                html += `<tr><td>${item.tanggal}</td><td>${item.kode}</td><td>${item.nama}</td><td>${item.keterangan}</td></tr>`;
            });
            html += '</table>';
            
            printContent.innerHTML = html;
            window.print();
        }
    </script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'97cd3f5346e6fe23',t:'MTc1NzQ4OTcxMy4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
